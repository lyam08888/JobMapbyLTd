<!DOCTYPE html>
<html lang="fr" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobMap by LTd - Trouvez des Emplois et Candidats</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha26-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; user-select: none; }
        .dark body { background-color: #111827; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        .leaflet-tile-pane { filter: brightness(1); transition: filter 0.3s ease-in-out; }
        .dark .leaflet-tile-pane { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
        #ui-overlay { z-index: 1001; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .dark .leaflet-popup-content-wrapper { background: #1f2937; color: #d1d5db; }
        .leaflet-popup-content { margin: 15px; font-size: 14px; line-height: 1.5; }
        .popup-title { font-weight: 700; font-size: 16px; margin-bottom: 5px; color: #1a202c; }
        .dark .popup-title, .dark .popup-company { color: #f9fafb; }
        .popup-company { font-weight: 500; color: #4a5568; margin-bottom: 10px; }
        .search-container { transition: all 0.3s ease-in-out; overflow: hidden; }
        #drag-handle { cursor: move; }
        .search-container.collapsed { width: 60px !important; height: 60px !important; padding: 0; }
        .search-container.collapsed #panel-content, .search-container.collapsed #drag-handle { display: none; }
        .search-container.collapsed #panel-header { padding: 0; height: 100%; border-bottom: none; display:flex; align-items:center; justify-content:center; }
        #toggle-panel-btn i { transition: transform 0.3s ease; }
        .search-container.collapsed #toggle-panel-btn i { transform: rotate(180deg); }
        .custom-marker-icon { display: flex; align-items: center; justify-content: center; color: white; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: transform 0.2s ease; }
        .custom-marker-icon:hover { transform: scale(1.2); }
        .user-location-icon { background-color: #f59e0b; border: 3px solid white; border-radius: 50%; width: 18px !important; height: 18px !important; box-shadow: 0 0 10px #f59e0b; }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 50% { transform: scale(1.2); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } }
        .pulsing { animation: pulse 1.5s infinite; }
        .modal-backdrop.hidden { display: none; }
        .modal-panel.hidden { transform: scale(0.95); opacity: 0; }
        .modal-panel { transition: all 0.2s ease-out; }
        .filter-btn, .sub-filter-btn { transition: all 0.2s ease-in-out; }
        .filter-btn.active, .sub-filter-btn.active { background-color: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .dark .filter-btn.active, .dark .sub-filter-btn.active { background-color: #2563eb; }
        #startup-overlay.fade-out { opacity: 0; }
        #progress-bar { animation: progressBar 1.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        @keyframes progressBar { from { width: 0%; } to { width: 100%; } }
        #user-menu { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .routing-mode-btn.active { background-color: #3b82f6; color: white; }
        .leaflet-routing-container { display: none; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px); opacity: 0; transition: all 0.4s ease; z-index: 9999; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #match-mode-btn.active, #favorites-btn.has-favorites, #dark-mode-toggle.dark-on { color: #ec4899; box-shadow: 0 0 10px #ec489950; }
        #match-mode-btn.active { color: #a855f7; box-shadow: 0 0 10px #a855f750; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; color: white; border: 6px solid; }
        .favorite-icon.is-favorite { color: #ec4899; }
        .result-card { padding: 0.75rem; margin-bottom: 0.5rem; }
        .result-card h3 { font-size: 0.95rem; font-weight: 600; }
        .result-card p { font-size: 0.8rem; }
        #results-list { transition: max-height 0.3s ease-in-out; max-height: 200px; /* Hauteur réduite par défaut */ overflow-y: auto; }
        #results-list.expanded { max-height: 45vh; /* Hauteur étendue */ }
        #advanced-filters { transition: all 0.3s ease-in-out; max-height: 500px; overflow: hidden; }
        #advanced-filters.collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; margin-bottom: 0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div id="startup-overlay" class="fixed inset-0 bg-gray-900 z-[9999] flex flex-col items-center justify-center text-white transition-opacity duration-1000 ease-in-out">
        <div id="logo-container" class="text-center opacity-0" style="animation: fadeIn 1s ease-in forwards;"><i class="fas fa-map-marked-alt text-8xl text-blue-400"></i><h1 class="text-5xl font-bold mt-4">JobMap <span class="font-light">by LTd</span></h1></div>
        <div id="loader-container" class="hidden w-1/3 max-w-sm mt-8"><div class="w-full bg-gray-700 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full"></div></div><p id="loading-text" class="text-center text-gray-300 mt-2 text-sm"></p></div>
    </div>
    
    <div id="toast-container"></div>

    <div id="app" class="relative w-screen h-screen">
        <div id="map"></div>
        <div id="ui-overlay" class="absolute top-0 left-0 w-full h-full p-4 md:p-6 pointer-events-none">
            
            <!-- Menu Utilisateur en bas à gauche -->
            <div class="absolute bottom-6 left-6 pointer-events-auto">
                <button id="user-menu-button" title="Menu utilisateur" class="w-14 h-14 bg-white dark:bg-gray-800 rounded-full shadow-lg flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-blue-500 transition"><i class="fas fa-user-circle text-4xl"></i></button>
                <div id="user-menu" class="absolute bottom-full mb-2 left-0 bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-64 p-2 origin-bottom-left transform scale-95 opacity-0 hidden"></div>
            </div>

            <!-- Barre d'outils en bas au centre -->
            <div class="absolute bottom-6 left-1/2 -translate-x-1/2 pointer-events-auto flex gap-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-full shadow-lg p-2">
                <button id="help-btn" title="Aide et tutoriel" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-question-circle text-xl"></i></button>
                <button id="locate-me-btn" title="Me localiser" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-crosshairs text-xl"></i></button>
                <button id="match-mode-btn" title="Activer le mode association" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-link text-xl"></i></button>
                <button id="favorites-btn" title="Voir les favoris" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition relative"><i class="fas fa-heart text-xl"></i><span id="favorites-count" class="absolute top-1 right-1 bg-pink-500 text-white text-xs font-bold rounded-full h-4 w-4 flex items-center justify-center hidden"></span></button>
                <button id="dark-mode-toggle" title="Changer de thème" class="w-12 h-12 rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 transition"><i class="fas fa-moon text-xl"></i></button>
            </div>


            <div id="search-panel" class="search-container absolute top-6 right-6 w-full max-w-sm md:max-w-xs lg:max-w-sm bg-white/80 dark:bg-gray-800/80 backdrop-blur-md rounded-xl shadow-2xl flex flex-col pointer-events-auto max-h-[90vh]">
                <div id="panel-header" class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <div id="drag-handle" class="flex items-center gap-3 flex-grow"><i class="fas fa-map-marked-alt text-3xl text-blue-500"></i><div><h1 class="text-xl font-bold text-gray-800 dark:text-gray-100">JobMap</h1><p class="text-sm text-gray-500 dark:text-gray-400">by LTd</p></div></div>
                    <button id="toggle-panel-btn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 flex-shrink-0"><i class="fas fa-chevron-left"></i></button>
                </div>
                <div id="panel-content" class="p-4 flex flex-col min-h-0">
                    <div class="relative py-2 flex-shrink-0">
                        <input type="text" id="search-input" placeholder="Poste, compétence..." class="w-full pl-10 pr-10 py-3 text-md bg-gray-100 dark:bg-gray-700 border-2 border-transparent dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <button id="save-search-btn" title="Sauvegarder cette recherche" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-500 transition">
                            <i class="fas fa-bookmark"></i>
                        </button>
                    </div>
                    <div class="mb-3 flex-shrink-0"><div id="filter-container" class="w-full flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1"><button class="filter-btn active w-1/3 text-center py-2 px-2 rounded-md font-semibold text-sm text-gray-700 dark:text-gray-300" data-filter="all">Tous</button><button class="filter-btn w-1/3 text-center py-2 px-2 rounded-md font-semibold text-sm text-gray-700 dark:text-gray-300" data-filter="job">Emplois</button><button class="filter-btn w-1/3 text-center py-2 px-2 rounded-md font-semibold text-sm text-gray-700 dark:text-gray-300" data-filter="candidate">Profils</button></div></div>
                    
                    <div id="toggle-filters-btn" class="flex justify-between items-center py-2 cursor-pointer flex-shrink-0">
                         <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-300">Filtres avancés</h4>
                         <i class="fas fa-chevron-up text-gray-500 dark:text-gray-400 transition-transform"></i>
                    </div>
                    <div id="advanced-filters" class="flex-shrink-0">
                        <div class="space-y-3 pt-2 mb-3">
                            <div><label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Type de contrat</label><div id="contract-filter-container" class="w-full flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1 text-xs"><button class="sub-filter-btn active w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-contract="all">Tous</button><button class="sub-filter-btn w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-contract="CDI">CDI</button><button class="sub-filter-btn w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-contract="CDD">CDD</button><button class="sub-filter-btn w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-contract="Alternance">Alternance</button></div></div>
                            <div><label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Mode de travail</label><div id="work-arrangement-filter-container" class="w-full flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1 text-xs"><button class="sub-filter-btn active w-1/3 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-work="all">Tous</button><button class="sub-filter-btn w-1/3 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-work="Sur site">Sur site</button><button class="sub-filter-btn w-1/3 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-work="Hybride">Hybride</button></div></div>
                            <div><label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Secteur</label><select id="industry-filter" class="w-full p-2 text-xs bg-gray-200 dark:bg-gray-700 rounded-lg border-none text-gray-700 dark:text-gray-300"><option value="all">Tous les secteurs</option><option value="Tech">Tech</option><option value="Data">Data/IA</option><option value="Design">Design</option><option value="Marketing">Marketing</option><option value="Finance">Finance</option><option value="Conseil">Conseil</option><option value="E-Commerce">E-Commerce</option><option value="Blockchain">Blockchain</option><option value="Communication">Communication</option><option value="RH">RH</option><option value="IoT">IoT</option><option value="Sécurité">Sécurité</option></select></div>
                            <div><label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Expérience</label><div id="experience-filter-container" class="w-full flex bg-gray-200 dark:bg-gray-700 rounded-lg p-1 text-xs"><button class="sub-filter-btn active w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-exp="all">Tous</button><button class="sub-filter-btn w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-exp="Junior">Junior</button><button class="sub-filter-btn w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-exp="Confirmé">Confirmé</button><button class="sub-filter-btn w-1/4 py-1.5 rounded-md text-gray-700 dark:text-gray-300" data-exp="Senior">Senior</button></div></div>
                            <div><label for="salary-slider" class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Salaire max: <span id="salary-value" class="font-bold text-blue-600 dark:text-blue-400"></span></label><input type="range" id="salary-slider" min="30000" max="120000" step="5000" value="120000" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"></div>
                            <div><label for="distance-slider" class="block text-xs font-semibold text-gray-500 dark:text-gray-400 mb-1">Distance max: <span id="distance-value" class="font-bold text-emerald-600 dark:text-emerald-400">50 km</span></label><input type="range" id="distance-slider" min="5" max="100" step="5" value="50" class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer"></div>
                            <div class="pt-2">
                                <button id="export-data-btn" class="w-full py-2 px-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-purple-600 transition">
                                    <i class="fas fa-download mr-2"></i>Exporter les résultats
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="results-header" class="flex justify-between items-center text-sm font-medium text-gray-500 dark:text-gray-400 mb-2 flex-shrink-0 hidden">
                        <span id="results-count"></span>
                        <button id="toggle-results-btn" title="Agrandir/Réduire" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600"><i class="fas fa-chevron-up"></i></button>
                    </div>
                    <div id="results-list" class="flex-1 min-h-0 hidden pr-2"></div>
                </div>
            </div>
            <div id="routing-controls" class="absolute top-[100px] right-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg p-1 flex gap-1 pointer-events-auto hidden"><button data-mode="car" class="routing-mode-btn w-10 h-10 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition active"><i class="fas fa-car"></i></button><button data-mode="bicycle" class="routing-mode-btn w-10 h-10 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="fas fa-bicycle"></i></button><button data-mode="foot" class="routing-mode-btn w-10 h-10 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition"><i class="fas fa-walking"></i></button><div class="border-l dark:border-gray-600 mx-1"></div><button id="clear-route-btn" class="w-10 h-10 rounded-md text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition"><i class="fas fa-times"></i></button></div>
        </div>
    </div>
    
    <div id="modal-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const startupOverlay = document.getElementById('startup-overlay'), logoContainer = document.getElementById('logo-container'), loaderContainer = document.getElementById('loader-container');
            setTimeout(() => { logoContainer.style.animation = 'fadeOut 1s ease-out forwards'; }, 1500);
            setTimeout(() => { logoContainer.classList.add('hidden'); loaderContainer.classList.remove('hidden'); loaderContainer.style.animation = 'fadeIn 1s ease-in forwards'; }, 2500);
            setTimeout(() => { startupOverlay.classList.add('fade-out'); startupOverlay.addEventListener('transitionend', () => startupOverlay.remove()); initializeApp(); }, 4200);

            function initializeApp() {
                const map = L.map('map').setView([46.603354, 1.888334], 6);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO', maxZoom: 20 }).addTo(map);

                const ui = {
                    userMenuButton: document.getElementById('user-menu-button'), userMenu: document.getElementById('user-menu'), helpBtn: document.getElementById('help-btn'), saveSearchBtn: document.getElementById('save-search-btn'), locateMeBtn: document.getElementById('locate-me-btn'), matchModeBtn: document.getElementById('match-mode-btn'), favoritesBtn: document.getElementById('favorites-btn'), favoritesCount: document.getElementById('favorites-count'), searchInput: document.getElementById('search-input'), resultsList: document.getElementById('results-list'), resultsHeader: document.getElementById('results-header'), resultsCount: document.getElementById('results-count'), toggleResultsBtn: document.getElementById('toggle-results-btn'), filterContainer: document.getElementById('filter-container'), advancedFilters: document.getElementById('advanced-filters'), toggleFiltersBtn: document.getElementById('toggle-filters-btn'), expFilterContainer: document.getElementById('experience-filter-container'), contractFilterContainer: document.getElementById('contract-filter-container'), workArrangementFilterContainer: document.getElementById('work-arrangement-filter-container'), industryFilter: document.getElementById('industry-filter'), salarySlider: document.getElementById('salary-slider'), salaryValue: document.getElementById('salary-value'), distanceSlider: document.getElementById('distance-slider'), distanceValue: document.getElementById('distance-value'), exportDataBtn: document.getElementById('export-data-btn'), routingControls: document.getElementById('routing-controls'), clearRouteBtn: document.getElementById('clear-route-btn'), searchPanel: document.getElementById('search-panel'), dragHandle: document.getElementById('drag-handle'), darkModeToggle: document.getElementById('dark-mode-toggle'), modalContainer: document.getElementById('modal-container'), togglePanelBtn: document.getElementById('toggle-panel-btn'),
                };
                
                let state = { currentUser: null, routingControl: null, userLocation: { lat: 48.85884, lon: 2.29435 }, userLocationMarker: null, firstInteraction: false, isMatchModeActive: false, matchStartPoint: null, markers: new Map(), favorites: new Set(), filters: { type: 'all', experience: 'all', salary: 120000, contract: 'all', workArrangement: 'all', industry: 'all', distance: 50 }, viewHistory: [], savedSearches: [] };

                const markerClusters = L.markerClusterGroup();
                map.addLayer(markerClusters);

                let data = [
                    { id: 1, type: 'job', title: 'Développeur Full-Stack', company: 'Tech Solutions Inc.', logo: 'https://placehold.co/100x100/3b82f6/ffffff?text=TSI', companyDescription: 'Leader en solutions logicielles B2B, nous innovons constamment pour nos clients.', industry: 'Tech', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['React', 'Node.js', 'TypeScript', 'SQL'], softSkills: ['Travail d\'équipe', 'Communication', 'Créativité'], experience: 'Confirmé', salary: 65000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Rejoignez notre équipe agile pour construire des applications web innovantes.' },
                    { id: 3, type: 'job', title: 'Data Scientist Senior', company: 'DataCorp', logo: 'https://placehold.co/100x100/10b981/ffffff?text=DC', companyDescription: 'Nous transformons les données en décisions stratégiques pour les entreprises du CAC40.', industry: 'Data', location: { lat: 48.8698, lon: 2.3344 }, city: 'Paris', tags: ['Python', 'Machine Learning', 'TensorFlow'], softSkills: ['Analyse critique', 'Résolution de problèmes'], experience: 'Senior', salary: 85000, contract: 'CDI', workArrangement: 'Télétravail', acceptsSpontaneous: true, description: 'Expert en Machine Learning pour développer des modèles prédictifs.' },
                    { id: 4, type: 'candidate', name: 'Jean Dupont', title: 'Développeur Backend', avatar: 'https://placehold.co/100x100/7c3aed/ffffff?text=JD', location: { lat: 48.8534, lon: 2.3488 }, city: 'Paris', tags: ['Java', 'Spring', 'SQL'], softSkills: ['Autonomie', 'Rigueur', 'Communication'], experience: 'Senior', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2008-2011', degree: 'Master Informatique', school: 'Université Paris-Saclay'}], certifications: ['Oracle Java Certified', 'Spring Professional'], background: [{ year: '2015-2023', role: 'Développeur Senior', company: 'Banque Générale'}, { year: '2012-2015', role: 'Développeur Java', company: 'Soft Services'}], description: '8 ans d\'expérience dans le secteur financier.' },
                    { id: 2, type: 'candidate', name: 'Alice Martin', title: 'Chef de Projet Digital', avatar: 'https://placehold.co/100x100/f59e0b/ffffff?text=AM', location: { lat: 45.7640, lon: 4.8357 }, city: 'Lyon', tags: ['Agile', 'Scrum', 'Gestion'], softSkills: ['Leadership', 'Organisation', 'Communication'], experience: 'Confirmé', availability: 'Sous 1 mois', portfolioLink: 'https://example.com', education: [{ year: '2013-2016', degree: 'Master Management Digital', school: 'EM Lyon'}], certifications: ['Scrum Master Certified', 'PMP'], background: [{ year: '2018-2023', role: 'Product Owner', company: 'WebAgency Lyon'}, { year: '2016-2018', role: 'Assistante Chef de Projet', company: 'Digital Corp'}], description: '5 ans d\'expérience, certifiée Scrum Master.' },
                    { id: 5, type: 'job', title: 'Designer UI/UX Junior', company: 'Creative Minds', logo: 'https://placehold.co/100x100/ec4899/ffffff?text=CM', companyDescription: 'Agence de design primée, nous créons des expériences digitales mémorables.', industry: 'Design', location: { lat: 45.7578, lon: 4.8320 }, city: 'Lyon', tags: ['Figma', 'Adobe XD', 'User Research'], softSkills: ['Créativité', 'Empathie', 'Collaboration'], experience: 'Junior', salary: 42000, contract: 'CDD', workArrangement: 'Sur site', acceptsSpontaneous: false, description: 'Nous cherchons un designer talentueux pour créer des interfaces intuitives.' },
                    { id: 6, type: 'job', title: 'Chef de projet Marketing', company: 'DataCorp', logo: 'https://placehold.co/100x100/10b981/ffffff?text=DC', companyDescription: 'Nous transformons les données en décisions stratégiques pour les entreprises du CAC40.', industry: 'Marketing', location: { lat: 48.875, lon: 2.33 }, city: 'Paris', tags: ['Marketing', 'SEO', 'SEA'], softSkills: ['Organisation', 'Communication'], experience: 'Confirmé', salary: 55000, contract: 'Alternance', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Gérez nos campagnes marketing digitales.' },
                    { id: 7, type: 'job', title: 'Développeur Mobile iOS', company: 'AppFactory', logo: 'https://placehold.co/100x100/8b5cf6/ffffff?text=AF', companyDescription: 'Startup innovante spécialisée dans les applications mobiles pour le secteur de la santé.', industry: 'Tech', location: { lat: 43.2965, lon: 5.3698 }, city: 'Marseille', tags: ['Swift', 'SwiftUI', 'CoreData'], softSkills: ['Innovation', 'Rigueur'], experience: 'Confirmé', salary: 58000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Développez des applications iOS de qualité médicale.' },
                    { id: 8, type: 'candidate', name: 'Sophie Bernard', title: 'DevOps Engineer', avatar: 'https://placehold.co/100x100/06b6d4/ffffff?text=SB', location: { lat: 43.6108, lon: 3.8767 }, city: 'Montpellier', tags: ['Docker', 'Kubernetes', 'AWS'], softSkills: ['Méthodique', 'Proactif'], experience: 'Confirmé', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2015-2017', degree: 'Master Systèmes Distribués', school: 'Université Montpellier'}], certifications: ['AWS Solutions Architect', 'CKA'], background: [{ year: '2019-2024', role: 'DevOps Engineer', company: 'CloudTech'}, { year: '2017-2019', role: 'Administrateur Système', company: 'HostNet'}], description: 'Experte en automatisation et CI/CD.' },
                    { id: 9, type: 'job', title: 'Architecte Cloud', company: 'CloudMasters', logo: 'https://placehold.co/100x100/14b8a6/ffffff?text=CM', companyDescription: 'Cabinet de conseil en architecture cloud et transformation digitale.', industry: 'Conseil', location: { lat: 47.2184, lon: -1.5536 }, city: 'Nantes', tags: ['AWS', 'Azure', 'Architecture'], softSkills: ['Leadership technique', 'Vision stratégique'], experience: 'Senior', salary: 95000, contract: 'CDI', workArrangement: 'Télétravail', acceptsSpontaneous: true, description: 'Concevez des architectures cloud scalables pour nos grands comptes.' },
                    { id: 10, type: 'candidate', name: 'Marc Rousseau', title: 'Ingénieur QA', avatar: 'https://placehold.co/100x100/f97316/ffffff?text=MR', location: { lat: 48.5734, lon: 7.7521 }, city: 'Strasbourg', tags: ['Selenium', 'Jest', 'Cypress'], softSkills: ['Minutieux', 'Analytique'], experience: 'Junior', availability: 'Sous 2 mois', portfolioLink: 'https://example.com', education: [{ year: '2020-2022', degree: 'Master Qualité Logicielle', school: 'INSA Strasbourg'}], certifications: ['ISTQB Foundation'], background: [{ year: '2022-2024', role: 'Testeur QA', company: 'TestLab'}], description: 'Passionné par la qualité logicielle et l\'automatisation des tests.' },
                    { id: 11, type: 'job', title: 'Product Manager', company: 'InnovateTech', logo: 'https://placehold.co/100x100/ef4444/ffffff?text=IT', companyDescription: 'Scale-up en pleine croissance dans le domaine de la fintech.', industry: 'Finance', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['Product Management', 'Agile', 'Analytics'], softSkills: ['Leadership', 'Vision produit', 'Communication'], experience: 'Confirmé', salary: 70000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Définissez la vision produit et coordonnez les équipes de développement.' },
                    { id: 12, type: 'candidate', name: 'Emma Lefebvre', title: 'UX Researcher', avatar: 'https://placehold.co/100x100/a855f7/ffffff?text=EL', location: { lat: 50.6292, lon: 3.0573 }, city: 'Lille', tags: ['User Research', 'Usability Testing', 'Figma'], softSkills: ['Empathie', 'Analyse', 'Communication'], experience: 'Confirmé', availability: 'Sous 1 mois', portfolioLink: 'https://example.com', education: [{ year: '2016-2018', degree: 'Master Design d\'Interface', school: 'Gobelins'}], certifications: ['Nielsen Norman UX Certificate'], background: [{ year: '2020-2024', role: 'UX Researcher', company: 'DesignStudio'}, { year: '2018-2020', role: 'UX Designer', company: 'WebCorp'}], description: 'Spécialisée en recherche utilisateur et tests d\'utilisabilité.' },
                    { id: 13, type: 'job', title: 'Ingénieur Sécurité', company: 'SecureSoft', logo: 'https://placehold.co/100x100/dc2626/ffffff?text=SS', companyDescription: 'Éditeur de solutions de cybersécurité pour les entreprises.', industry: 'Sécurité', location: { lat: 43.6047, lon: 1.4442 }, city: 'Toulouse', tags: ['Pentest', 'SIEM', 'Cryptographie'], softSkills: ['Rigueur', 'Curiosité', 'Éthique'], experience: 'Senior', salary: 80000, contract: 'CDI', workArrangement: 'Sur site', acceptsSpontaneous: false, description: 'Protégez nos clients contre les cybermenaces et réalisez des audits de sécurité.' },
                    { id: 14, type: 'candidate', name: 'Thomas Dubois', title: 'Développeur Frontend', avatar: 'https://placehold.co/100x100/0ea5e9/ffffff?text=TD', location: { lat: 47.4784, lon: -0.5632 }, city: 'Angers', tags: ['Vue.js', 'Nuxt', 'TailwindCSS'], softSkills: ['Créativité', 'Détail', 'Collaboration'], experience: 'Junior', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2021-2023', degree: 'Licence Informatique', school: 'Université Angers'}], certifications: [], background: [{ year: '2023-2024', role: 'Développeur Frontend', company: 'WebStudio'}], description: 'Développeur frontend passionné par les interfaces modernes et performantes.' },
                    { id: 15, type: 'job', title: 'Consultant SAP', company: 'BusinessTech', logo: 'https://placehold.co/100x100/84cc16/ffffff?text=BT', companyDescription: 'Cabinet de conseil spécialisé en transformation digitale et ERP.', industry: 'Conseil', location: { lat: 48.1173, lon: -1.6778 }, city: 'Rennes', tags: ['SAP', 'ABAP', 'Gestion de projet'], softSkills: ['Conseil', 'Adaptabilité', 'Communication'], experience: 'Confirmé', salary: 72000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Accompagnez nos clients dans leurs projets SAP et transformation digitale.' },
                    { id: 16, type: 'job', title: 'Développeur Backend Python', company: 'Tech Solutions Inc.', logo: 'https://placehold.co/100x100/3b82f6/ffffff?text=TSI', companyDescription: 'Leader en solutions logicielles B2B, nous innovons constamment pour nos clients.', industry: 'Tech', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['Python', 'Django', 'PostgreSQL', 'Redis'], softSkills: ['Autonomie', 'Problem Solving'], experience: 'Confirmé', salary: 60000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Développez des APIs robustes et scalables pour nos clients B2B.' },
                    { id: 17, type: 'candidate', name: 'Léa Roussel', title: 'Data Analyst', avatar: 'https://placehold.co/100x100/22c55e/ffffff?text=LR', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['SQL', 'Python', 'Tableau', 'Power BI'], softSkills: ['Analytique', 'Communication', 'Curiosité'], experience: 'Junior', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2021-2023', degree: 'Master Data Science', school: 'ENSAE'}], certifications: ['Google Data Analytics'], background: [{ year: '2023-2024', role: 'Stagiaire Data', company: 'Big Corp'}], description: 'Passionnée par l\'analyse de données et la visualisation.' },
                    { id: 18, type: 'job', title: 'Responsable E-Commerce', company: 'ShopDigital', logo: 'https://placehold.co/100x100/f43f5e/ffffff?text=SD', companyDescription: 'Plateforme e-commerce innovante avec plus de 2M de clients actifs.', industry: 'E-Commerce', location: { lat: 48.8738, lon: 2.2950 }, city: 'Paris', tags: ['E-commerce', 'Google Analytics', 'SEO'], softSkills: ['Stratégie', 'Leadership', 'Créativité'], experience: 'Senior', salary: 75000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Pilotez notre stratégie e-commerce et optimisez les conversions.' },
                    { id: 19, type: 'candidate', name: 'Pierre Durand', title: 'Développeur Mobile Flutter', avatar: 'https://placehold.co/100x100/6366f1/ffffff?text=PD', location: { lat: 45.7640, lon: 4.8357 }, city: 'Lyon', tags: ['Flutter', 'Dart', 'Firebase', 'REST API'], softSkills: ['Créativité', 'Autonomie', 'Persévérance'], experience: 'Confirmé', availability: 'Sous 1 mois', portfolioLink: 'https://example.com', education: [{ year: '2016-2019', degree: 'Licence Informatique', school: 'Université Lyon 1'}], certifications: ['Google Flutter Developer'], background: [{ year: '2019-2024', role: 'Développeur Mobile', company: 'MobileApps SA'}], description: '5 ans d\'expérience dans le développement d\'applications mobiles cross-platform.' },
                    { id: 20, type: 'job', title: 'Chef de Projet IT', company: 'CloudMasters', logo: 'https://placehold.co/100x100/14b8a6/ffffff?text=CM', companyDescription: 'Cabinet de conseil en architecture cloud et transformation digitale.', industry: 'Conseil', location: { lat: 47.2184, lon: -1.5536 }, city: 'Nantes', tags: ['Gestion de projet', 'Agile', 'ITIL'], softSkills: ['Organisation', 'Communication', 'Leadership'], experience: 'Confirmé', salary: 68000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Gérez des projets d\'infrastructure cloud pour nos clients grands comptes.' },
                    { id: 21, type: 'candidate', name: 'Camille Petit', title: 'Graphiste 3D', avatar: 'https://placehold.co/100x100/ec4899/ffffff?text=CP', location: { lat: 43.2965, lon: 5.3698 }, city: 'Marseille', tags: ['Blender', 'Cinema 4D', 'After Effects'], softSkills: ['Créativité', 'Attention au détail', 'Passion'], experience: 'Junior', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2020-2023', degree: 'Bachelor Design 3D', school: 'Les Gobelins'}], certifications: [], background: [{ year: '2023-2024', role: 'Graphiste 3D', company: 'Studio Créatif'}], description: 'Créateur de visuels 3D pour l\'animation et le jeu vidéo.' },
                    { id: 22, type: 'job', title: 'Développeur Blockchain', company: 'CryptoTech', logo: 'https://placehold.co/100x100/8b5cf6/ffffff?text=CT', companyDescription: 'Startup pionnière dans les solutions blockchain pour la finance décentralisée.', industry: 'Blockchain', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['Solidity', 'Web3', 'Ethereum', 'Smart Contracts'], softSkills: ['Innovation', 'Rigueur', 'Curiosité'], experience: 'Confirmé', salary: 78000, contract: 'CDI', workArrangement: 'Télétravail', acceptsSpontaneous: true, description: 'Développez des smart contracts et applications décentralisées innovantes.' },
                    { id: 23, type: 'candidate', name: 'Lucas Martin', title: 'Architecte Logiciel', avatar: 'https://placehold.co/100x100/0ea5e9/ffffff?text=LM', location: { lat: 50.6292, lon: 3.0573 }, city: 'Lille', tags: ['Architecture', 'Microservices', 'DDD', 'Cloud'], softSkills: ['Vision technique', 'Mentoring', 'Communication'], experience: 'Senior', availability: 'Sous 3 mois', portfolioLink: 'https://example.com', education: [{ year: '2008-2013', degree: 'Ingénieur Informatique', school: 'Centrale Lille'}], certifications: ['AWS Solutions Architect Pro', 'TOGAF'], background: [{ year: '2018-2024', role: 'Architecte', company: 'Tech Leader'}, { year: '2013-2018', role: 'Lead Dev', company: 'Dev Solutions'}], description: '11 ans d\'expérience dans la conception d\'architectures complexes.' },
                    { id: 24, type: 'job', title: 'Community Manager', company: 'SocialMedia Pro', logo: 'https://placehold.co/100x100/f59e0b/ffffff?text=SMP', companyDescription: 'Agence spécialisée en gestion de communautés et stratégie social media.', industry: 'Communication', location: { lat: 45.7640, lon: 4.8357 }, city: 'Lyon', tags: ['Social Media', 'Content Creation', 'Analytics'], softSkills: ['Créativité', 'Communication', 'Réactivité'], experience: 'Junior', salary: 35000, contract: 'CDD', workArrangement: 'Hybride', acceptsSpontaneous: false, description: 'Animez les communautés de nos clients sur les réseaux sociaux.' },
                    { id: 25, type: 'candidate', name: 'Julie Moreau', title: 'Ingénieur DevSecOps', avatar: 'https://placehold.co/100x100/dc2626/ffffff?text=JM', location: { lat: 43.6047, lon: 1.4442 }, city: 'Toulouse', tags: ['DevOps', 'Security', 'Jenkins', 'Kubernetes'], softSkills: ['Rigueur', 'Proactif', 'Collaboration'], experience: 'Confirmé', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2014-2017', degree: 'Master Cybersécurité', school: 'INSA Toulouse'}], certifications: ['CISSP', 'CKA'], background: [{ year: '2017-2024', role: 'DevSecOps', company: 'SecureCloud'}], description: '7 ans d\'expérience en sécurité et automatisation.' },
                    { id: 26, type: 'job', title: 'Business Analyst', company: 'BusinessTech', logo: 'https://placehold.co/100x100/84cc16/ffffff?text=BT', companyDescription: 'Cabinet de conseil spécialisé en transformation digitale et ERP.', industry: 'Conseil', location: { lat: 48.1173, lon: -1.6778 }, city: 'Rennes', tags: ['Business Analysis', 'SQL', 'UML'], softSkills: ['Analyse', 'Communication', 'Synthèse'], experience: 'Confirmé', salary: 55000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Analysez les besoins métiers et proposez des solutions adaptées.' },
                    { id: 27, type: 'candidate', name: 'Alexandre Blanc', title: 'Développeur Jeux Vidéo', avatar: 'https://placehold.co/100x100/8b5cf6/ffffff?text=AB', location: { lat: 45.7640, lon: 4.8357 }, city: 'Lyon', tags: ['Unity', 'C#', 'Game Design'], softSkills: ['Créativité', 'Passion', 'Travail d\'équipe'], experience: 'Junior', availability: 'Immédiate', portfolioLink: 'https://example.com', education: [{ year: '2019-2022', degree: 'Bachelor Game Design', school: 'Gaming Campus'}], certifications: ['Unity Certified Developer'], background: [{ year: '2022-2024', role: 'Game Developer', company: 'Indie Studio'}], description: 'Développeur passionné avec plusieurs jeux indés publiés.' },
                    { id: 28, type: 'job', title: 'Responsable RH Digital', company: 'HR Innov', logo: 'https://placehold.co/100x100/10b981/ffffff?text=HRI', companyDescription: 'Transformation digitale des ressources humaines pour les grandes entreprises.', industry: 'RH', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['RH', 'Digital', 'Change Management'], softSkills: ['Empathie', 'Leadership', 'Communication'], experience: 'Senior', salary: 65000, contract: 'CDI', workArrangement: 'Hybride', acceptsSpontaneous: true, description: 'Pilotez la transformation digitale RH de nos clients.' },
                    { id: 29, type: 'candidate', name: 'Sarah Dubois', title: 'Développeur IA/ML', avatar: 'https://placehold.co/100x100/06b6d4/ffffff?text=SD', location: { lat: 48.8566, lon: 2.3522 }, city: 'Paris', tags: ['Python', 'TensorFlow', 'PyTorch', 'NLP'], softSkills: ['Analytique', 'Curiosité', 'Innovation'], experience: 'Confirmé', availability: 'Sous 2 mois', portfolioLink: 'https://example.com', education: [{ year: '2016-2018', degree: 'PhD Machine Learning', school: 'Université Paris-Saclay'}], certifications: ['TensorFlow Developer'], background: [{ year: '2018-2024', role: 'ML Engineer', company: 'AI Research Lab'}], description: 'Docteure en ML, experte en NLP et vision par ordinateur.' },
                    { id: 30, type: 'job', title: 'Ingénieur IoT', company: 'Connected Devices', logo: 'https://placehold.co/100x100/f43f5e/ffffff?text=CD', companyDescription: 'Fabricant de solutions IoT pour la smart city et l\'industrie 4.0.', industry: 'IoT', location: { lat: 43.6108, lon: 3.8767 }, city: 'Montpellier', tags: ['IoT', 'MQTT', 'C++', 'Arduino'], softSkills: ['Innovation', 'Problem Solving', 'Rigueur'], experience: 'Confirmé', salary: 62000, contract: 'CDI', workArrangement: 'Sur site', acceptsSpontaneous: true, description: 'Concevez des solutions IoT innovantes pour nos projets smart city.' }
                ];

                const createModal = (id, content) => { const modal = document.createElement('div'); modal.id = id; modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 z-[1050] hidden items-center justify-center'; modal.innerHTML = content; ui.modalContainer.appendChild(modal); };
                const modals = {
                    details: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div id="details-modal-content" class="overflow-y-auto"></div></div>',
                    login: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Connexion</h2><form id="login-form"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label><input type="email" name="email" value="recruteur@jobmap.com" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" required></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Mot de passe</label><input type="password" name="password" value="password" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg" required></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition shadow-lg">Se connecter</button></form></div></div>',
                    signupCandidate: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Créer un profil Candidat</h2><form id="signup-candidate-form" class="space-y-4"><input name="name" placeholder="Nom complet" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="email" type="email" placeholder="Email" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="title" placeholder="Titre du profil (ex: Développeur Web)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><textarea name="tags" placeholder="Compétences (séparées par des virgules)" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required></textarea><button type="submit" class="w-full bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition">Créer mon profil</button></form></div></div>',
                    signupRecruiter: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Créer un compte Recruteur</h2><form id="signup-recruiter-form" class="space-y-4"><input name="name" placeholder="Votre nom" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="email" type="email" placeholder="Email professionnel" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="company" placeholder="Nom de l\'entreprise" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition">Créer mon compte</button></form></div></div>',
                    signupEmployer: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Créer un compte Employeur</h2><form id="signup-employer-form" class="space-y-4"><input name="companyName" placeholder="Nom de l\'entreprise" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="name" placeholder="Votre nom" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="email" type="email" placeholder="Email professionnel" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="password" type="password" placeholder="Mot de passe" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><input name="siret" placeholder="Numéro SIRET" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-700 transition">Créer mon compte</button></form></div></div>',
                    postJob: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Poster une nouvelle offre</h2><form id="post-job-form" class="space-y-4"><input name="title" placeholder="Titre du poste" class="w-full p-2 border rounded dark:bg-gray-700" required><input name="company" placeholder="Nom de l\'entreprise" class="w-full p-2 border rounded dark:bg-gray-700" required><input name="city" placeholder="Ville" class="w-full p-2 border rounded dark:bg-gray-700" required><textarea name="description" placeholder="Description du poste" class="w-full p-2 border rounded dark:bg-gray-700" rows="4" required></textarea><input name="tags" placeholder="Compétences techniques (virgules)" class="w-full p-2 border rounded dark:bg-gray-700" required><input name="softSkills" placeholder="Compétences comportementales (virgules)" class="w-full p-2 border rounded dark:bg-gray-700" required><select name="experience" class="w-full p-2 border rounded dark:bg-gray-700" required><option>Junior</option><option>Confirmé</option><option>Senior</option></select><input name="salary" type="number" placeholder="Salaire annuel brut" class="w-full p-2 border rounded dark:bg-gray-700" required><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">Publier l\'offre</button></form></div></div>',
                    editProfile: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Modifier mon profil</h2><form id="edit-profile-form" class="space-y-4"></form></div></div>',
                    matchReport: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl m-4 p-8 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button><h2 class="text-3xl font-bold text-center mb-6 text-gray-800 dark:text-white">Rapport de Compatibilité</h2><div id="match-report-content" class="overflow-y-auto"></div></div>',
                    favorites: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 p-8 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Mes Favoris</h2><div id="favorites-list" class="overflow-y-auto"></div></div>',
                    dashboard: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl m-4 p-8 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button><h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Tableau de Bord</h2><div id="dashboard-content" class="overflow-y-auto"></div></div>',
                    company: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl m-4 p-8 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button><div id="company-profile-content" class="overflow-y-auto"></div></div>',
                    spontaneousApplication: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button><div class="overflow-y-auto p-8"><h2 class="text-2xl font-bold text-center mb-6 dark:text-white"><i class="fas fa-paper-plane text-blue-500 mr-2"></i>Candidature Spontanée</h2><form id="spontaneous-application-form" class="space-y-4"><div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg mb-4"><p class="text-sm text-gray-700 dark:text-gray-300"><i class="fas fa-info-circle mr-2"></i>Envoyez votre candidature spontanée aux entreprises qui acceptent ce type de candidature.</p></div><input name="company" placeholder="Nom de l\'entreprise" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required><textarea name="message" placeholder="Votre message de motivation..." class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" rows="6" required></textarea><div class="flex items-center gap-2 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg"><i class="fas fa-file-pdf text-red-500 text-xl"></i><span class="text-sm text-gray-600 dark:text-gray-300">CV à joindre (simulation)</span></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition"><i class="fas fa-paper-plane mr-2"></i>Envoyer la candidature</button></form></div></div>',
                    messages: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl m-4 p-8 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button><h2 class="text-2xl font-bold text-center mb-6 dark:text-white"><i class="fas fa-envelope mr-2"></i>Messages</h2><div id="messages-content" class="overflow-y-auto"></div></div>',
                    jobAlerts: '<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 p-8 transform hidden relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times fa-2x"></i></button><h2 class="text-2xl font-bold text-center mb-6 dark:text-white"><i class="fas fa-bell mr-2"></i>Alertes Emploi</h2><div id="job-alerts-content" class="overflow-y-auto"></div></div>'
                };
                for(const [key, value] of Object.entries(modals)) { createModal(key + '-modal', value); }

                function showToast(message, type = 'info') { const el = document.createElement('div'); el.className = `toast p-4 text-white rounded-lg shadow-lg flex items-center gap-3 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`; el.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i><span>${message}</span>`; document.getElementById('toast-container').appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); el.addEventListener('transitionend', () => el.remove()); }, 3000); }
                function openModal(modalId) { closeAllModals(); const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); setTimeout(() => modal.querySelector('.modal-panel').classList.remove('hidden'), 10); } }
                function closeAllModals() { ui.modalContainer.querySelectorAll('.modal-backdrop').forEach(modal => { modal.querySelector('.modal-panel')?.classList.add('hidden'); modal.classList.add('hidden'); modal.classList.remove('flex'); }); }
                
                function updateAuthUI() { 
                    let html = '';
                    if (state.currentUser) {
                        html = `<div class="p-2 text-gray-800 dark:text-gray-100"><p class="font-semibold">${state.currentUser.name}</p><p class="text-sm text-gray-500 dark:text-gray-400">${state.currentUser.email}</p></div><hr class="my-2 dark:border-gray-700">`;
                        if(state.currentUser.type === 'recruiter' || state.currentUser.type === 'employer') {
                            html += `<a href="#" data-action="post-job" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-plus-circle w-5 text-blue-500"></i>Poster une offre</a>`;
                            html += `<a href="#" data-action="dashboard" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-chart-line w-5 text-green-500"></i>Tableau de bord</a>`;
                            html += `<a href="#" data-action="messages" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-envelope w-5 text-purple-500"></i>Messages</a>`;
                        }
                        if(state.currentUser.type === 'candidate') {
                           html += `<a href="#" data-action="edit-profile" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-user-edit w-5 text-blue-500"></i>Mon Profil</a>`;
                           html += `<a href="#" data-action="dashboard" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-chart-line w-5 text-green-500"></i>Mes candidatures</a>`;
                           html += `<a href="#" data-action="spontaneous-application" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-paper-plane w-5 text-indigo-500"></i>Candidature spontanée</a>`;
                           html += `<a href="#" data-action="salary-insights" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-chart-bar w-5 text-teal-500"></i>Baromètre des salaires</a>`;
                           html += `<a href="#" data-action="job-alerts" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-bell w-5 text-yellow-500"></i>Alertes emploi</a>`;
                           html += `<a href="#" data-action="messages" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-envelope w-5 text-purple-500"></i>Messages</a>`;
                        }
                        html += `<a href="#" data-action="saved-searches" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-bookmark w-5 text-orange-500"></i>Recherches sauvegardées</a>`;
                        html += `<a href="#" data-action="view-history" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-history w-5 text-gray-500"></i>Historique</a>`;
                        html += `<a href="#" data-action="notifications" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-bell w-5 text-red-500"></i>Notifications<span class="ml-auto bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">3</span></a>`;
                        html += `<hr class="my-2 dark:border-gray-700">`;
                        html += `<a href="#" data-action="logout" class="flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md"><i class="fas fa-sign-out-alt w-5"></i>Se déconnecter</a>`;
                    } else {
                        html = `<p class="px-4 pt-2 pb-1 text-xs font-semibold text-gray-500 uppercase">S'inscrire</p>
                            <a href="#" data-action="signup-candidate" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-user-graduate w-5 text-emerald-500"></i><span>Je suis candidat</span></a>
                            <a href="#" data-action="signup-recruiter" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-user-tie w-5 text-indigo-500"></i><span>Je suis recruteur</span></a>
                            <a href="#" data-action="signup-employer" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-building w-5 text-sky-500"></i><span>Je suis employeur</span></a><hr class="my-2 dark:border-gray-700"><a href="#" data-action="login" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md"><i class="fas fa-sign-in-alt w-5"></i><span>Se connecter</span></a>`;
                    }
                    ui.userMenu.innerHTML = html;
                }
                
                function showDashboard() {
                    if (!state.currentUser) { showToast('Connectez-vous pour accéder au tableau de bord.', 'error'); openModal('login-modal'); return; }
                    
                    let content = '';
                    if (state.currentUser.type === 'candidate') {
                        const applications = state.applications ? state.applications.filter(a => a.candidateId === state.currentUser.id) : [];
                        const profileViews = Math.floor(Math.random() * 150) + 50;
                        const savedJobs = Array.from(state.favorites).filter(id => data.find(d => d.id === id && d.type === 'job')).length;
                        
                        content = `<div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Candidatures</p>
                                            <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">${applications.length}</p>
                                        </div>
                                        <i class="fas fa-paper-plane text-4xl text-blue-600 dark:text-blue-400 opacity-50"></i>
                                    </div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Vues du profil</p>
                                            <p class="text-3xl font-bold text-green-600 dark:text-green-400">${profileViews}</p>
                                        </div>
                                        <i class="fas fa-eye text-4xl text-green-600 dark:text-green-400 opacity-50"></i>
                                    </div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Offres sauvegardées</p>
                                            <p class="text-3xl font-bold text-purple-600 dark:text-purple-400">${savedJobs}</p>
                                        </div>
                                        <i class="fas fa-heart text-4xl text-purple-600 dark:text-purple-400 opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold mb-4 dark:text-white">Mes candidatures récentes</h3>
                                ${applications.length > 0 ? `<div class="space-y-3">
                                    ${applications.slice(0, 5).map(app => {
                                        const job = data.find(j => j.id === app.jobId);
                                        if (!job) return '';
                                        const statusColors = { pending: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300', accepted: 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300', rejected: 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300' };
                                        const statusLabels = { pending: 'En attente', accepted: 'Acceptée', rejected: 'Refusée' };
                                        return `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center">
                                            <div>
                                                <h4 class="font-semibold dark:text-white">${job.title}</h4>
                                                <p class="text-sm text-gray-600 dark:text-gray-300">${job.company}</p>
                                                <p class="text-xs text-gray-500 mt-1">${new Date(app.date).toLocaleDateString('fr-FR')}</p>
                                            </div>
                                            <span class="px-3 py-1 rounded-full text-sm ${statusColors[app.status]}">${statusLabels[app.status]}</span>
                                        </div>`;
                                    }).join('')}
                                </div>` : '<p class="text-gray-500 text-center py-8">Aucune candidature pour le moment.</p>'}
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold mb-4 dark:text-white">Recommandations pour vous</h3>
                                <div class="space-y-3">
                                    ${data.filter(item => item.type === 'job').slice(0, 3).map(job => {
                                        const matchScore = Math.floor(Math.random() * 30) + 70;
                                        return `<div class="p-4 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg cursor-pointer hover:shadow-md transition" onclick="showDetailsModal(${job.id})">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="font-semibold dark:text-white">${job.title}</h4>
                                                <span class="px-3 py-1 rounded-full text-xs font-bold ${matchScore >= 85 ? 'bg-green-500 text-white' : matchScore >= 70 ? 'bg-yellow-500 text-white' : 'bg-gray-400 text-white'}">
                                                    ${matchScore}% compatible
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 dark:text-gray-300">${job.company} • ${job.city}</p>
                                            <div class="flex items-center gap-2 mt-2">
                                                ${job.tags.slice(0, 3).map(tag => `<span class="text-xs px-2 py-1 bg-white dark:bg-gray-800 rounded">${tag}</span>`).join('')}
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>`;
                    } else if (state.currentUser.type === 'recruiter' || state.currentUser.type === 'employer') {
                        const myJobs = data.filter(j => j.type === 'job');
                        const totalApplications = state.applications ? state.applications.filter(a => myJobs.some(j => j.id === a.jobId)).length : 0;
                        const activeJobs = myJobs.length;
                        const candidateViews = Math.floor(Math.random() * 200) + 100;
                        
                        content = `<div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Offres actives</p>
                                            <p class="text-3xl font-bold text-blue-600 dark:text-blue-400">${activeJobs}</p>
                                        </div>
                                        <i class="fas fa-briefcase text-4xl text-blue-600 dark:text-blue-400 opacity-50"></i>
                                    </div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Candidatures reçues</p>
                                            <p class="text-3xl font-bold text-green-600 dark:text-green-400">${totalApplications}</p>
                                        </div>
                                        <i class="fas fa-user-check text-4xl text-green-600 dark:text-green-400 opacity-50"></i>
                                    </div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Profils consultés</p>
                                            <p class="text-3xl font-bold text-purple-600 dark:text-purple-400">${candidateViews}</p>
                                        </div>
                                        <i class="fas fa-users text-4xl text-purple-600 dark:text-purple-400 opacity-50"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold mb-4 dark:text-white">Mes offres d'emploi</h3>
                                ${myJobs.length > 0 ? `<div class="space-y-3">
                                    ${myJobs.slice(0, 5).map(job => {
                                        const apps = state.applications ? state.applications.filter(a => a.jobId === job.id) : [];
                                        return `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-1">
                                                    <h4 class="font-semibold dark:text-white">${job.title}</h4>
                                                    <p class="text-sm text-gray-600 dark:text-gray-300">${job.city} • ${job.contract}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${apps.length}</p>
                                                    <p class="text-xs text-gray-500">candidatures</p>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>` : '<p class="text-gray-500 text-center py-8">Aucune offre publiée pour le moment.</p>'}
                            </div>
                            
                            <div>
                                <h3 class="text-xl font-bold mb-4 dark:text-white">Candidats recommandés</h3>
                                <div class="space-y-3">
                                    ${data.filter(item => item.type === 'candidate').slice(0, 3).map(candidate => {
                                        const matchScore = Math.floor(Math.random() * 25) + 75;
                                        return `<div class="p-4 bg-gradient-to-r from-emerald-50 to-blue-50 dark:from-emerald-900/20 dark:to-blue-900/20 rounded-lg cursor-pointer hover:shadow-md transition" onclick="showDetailsModal(${candidate.id})">
                                            <div class="flex items-start gap-3">
                                                ${candidate.avatar ? `<img src="${candidate.avatar}" class="w-12 h-12 rounded-full">` : '<div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center"><i class="fas fa-user text-gray-600"></i></div>'}
                                                <div class="flex-1">
                                                    <div class="flex justify-between items-start">
                                                        <h4 class="font-semibold dark:text-white">${candidate.name}</h4>
                                                        <span class="px-3 py-1 rounded-full text-xs font-bold ${matchScore >= 85 ? 'bg-green-500 text-white' : matchScore >= 70 ? 'bg-yellow-500 text-white' : 'bg-gray-400 text-white'}">
                                                            ${matchScore}% match
                                                        </span>
                                                    </div>
                                                    <p class="text-sm text-gray-600 dark:text-gray-300">${candidate.title}</p>
                                                    <div class="flex items-center gap-2 mt-2">
                                                        ${candidate.tags.slice(0, 3).map(tag => `<span class="text-xs px-2 py-1 bg-white dark:bg-gray-800 rounded">${tag}</span>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>`;
                    }
                    
                    document.getElementById('dashboard-content').innerHTML = content;
                    openModal('dashboard-modal');
                }

                function calculateRoute(start, end) { if (state.routingControl) map.removeControl(state.routingControl); state.routingControl = L.Routing.control({ waypoints: [L.latLng(start.lat, start.lon), L.latLng(end.lat, end.lon)], router: L.Routing.osrmv1({ serviceUrl: `https://router.project-osrm.org/route/v1`, profile: 'car' }), createMarker: () => null, lineOptions: { styles: [{color: '#0ea5e9', opacity: 0.8, weight: 6}] } }).addTo(map); ui.routingControls.classList.remove('hidden'); }
                function toggleMatchMode() { state.isMatchModeActive = !state.isMatchModeActive; ui.matchModeBtn.classList.toggle('active', state.isMatchModeActive); showToast(state.isMatchModeActive ? "Mode Association activé." : "Mode Association désactivé.", "info"); if (!state.isMatchModeActive && state.matchStartPoint) { state.markers.get(state.matchStartPoint.id)?._icon.classList.remove('pulsing'); state.matchStartPoint = null; } }
                function calculateAndShowMatchReport(candidate, job) { const calculateScore = (jobSkills, candidateSkills) => { const common = [...jobSkills].filter(skill => candidateSkills.has(skill)); const missing = [...jobSkills].filter(skill => !candidateSkills.has(skill)); const score = jobSkills.size > 0 ? Math.round((common.length / jobSkills.size) * 100) : 0; return { common, missing, score }; }; const techReport = calculateScore(new Set(job.tags.map(t=>t.toLowerCase())), new Set(candidate.tags.map(t=>t.toLowerCase()))); const softReport = calculateScore(new Set(job.softSkills.map(t=>t.toLowerCase())), new Set(candidate.softSkills.map(t=>t.toLowerCase()))); const totalScore = Math.round((techReport.score * 0.7) + (softReport.score * 0.3)); let scoreColor, recommendation; if (totalScore >= 75) { scoreColor = 'bg-green-500 border-green-600'; recommendation = '<p class="text-lg font-semibold text-green-700"><i class="fas fa-check-circle mr-2"></i>Excellente compatibilité !</p>'; } else if (totalScore >= 40) { scoreColor = 'bg-yellow-500 border-yellow-600'; recommendation = '<p class="text-lg font-semibold text-yellow-700"><i class="fas fa-info-circle mr-2"></i>Bonne compatibilité.</p>'; } else { scoreColor = 'bg-red-500 border-red-600'; recommendation = '<p class="text-lg font-semibold text-red-700"><i class="fas fa-exclamation-triangle mr-2"></i>Compatibilité faible.</p>'; } const listSkills = (skills, color) => skills.map(s => `<span class="bg-${color}-100 dark:bg-${color}-900/40 text-${color}-800 dark:text-${color}-300 px-2 py-1 text-sm rounded">${s}</span>`).join(' ') || '<span>-</span>'; const content = `<div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-center"><div class="md:col-span-1 flex flex-col items-center text-center"><div class="score-circle ${scoreColor}">${totalScore}%</div><h3 class="text-2xl font-bold mt-4 dark:text-white">Score Global</h3></div><div class="md:col-span-2"><div class="mb-4"><h4 class="font-bold text-lg dark:text-white">${candidate.name} (${candidate.experience})</h4><p class="text-gray-600 dark:text-gray-300">${candidate.title}</p></div><div class="text-center my-2"><i class="fas fa-arrows-alt-v text-gray-400 text-2xl"></i></div><div><h4 class="font-bold text-lg dark:text-white">${job.title} (${job.experience})</h4><p class="text-gray-600 dark:text-gray-300">${job.company}</p></div></div></div><hr class="my-6 dark:border-gray-600"><div><h3 class="font-bold text-xl mb-4 dark:text-white">Analyse des Compétences</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Techniques (${techReport.common.length}/${job.tags.length})</h4><div class="flex flex-wrap gap-2">${listSkills(techReport.common, 'green')}</div>${techReport.missing.length > 0 ? `<div class="mt-2"><h5 class="text-xs text-red-500">Manquantes:</h5><div class="flex flex-wrap gap-1">${listSkills(techReport.missing, 'red')}</div></div>` : ''}</div></div><div class="space-y-4"><div><h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">Comportementales (${softReport.common.length}/${job.softSkills.length})</h4><div class="flex flex-wrap gap-2">${listSkills(softReport.common, 'green')}</div>${softReport.missing.length > 0 ? `<div class="mt-2"><h5 class="text-xs text-red-500">Manquantes:</h5><div class="flex flex-wrap gap-1">${listSkills(softReport.missing, 'red')}</div></div>` : ''}</div></div></div></div><div class="mt-8 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg text-center">${recommendation}</div><div class="mt-8 flex justify-end gap-4"><button class="close-modal-btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500">Fermer</button><button id="view-route-from-report" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700">Voir l'itinéraire</button></div>`; document.getElementById('match-report-content').innerHTML = content; document.getElementById('view-route-from-report').onclick = () => { closeAllModals(); calculateRoute(candidate.location, job.location); }; openModal('matchReport-modal'); }
                function toggleFavorite(id) { if (state.favorites.has(id)) { state.favorites.delete(id); showToast('Retiré des favoris.', 'info'); } else { state.favorites.add(id); showToast('Ajouté aux favoris !', 'success'); } ui.favoritesCount.textContent = state.favorites.size; ui.favoritesCount.classList.toggle('hidden', state.favorites.size === 0); ui.favoritesBtn.classList.toggle('has-favorites', state.favorites.size > 0); performSearch(); }
                
                function showDetailsModal(itemId) {
                    const item = data.find(d => d.id === itemId);
                    if (!item) return;
                    
                    // Track viewing history
                    if (!state.viewHistory.find(v => v.id === itemId)) {
                        state.viewHistory.unshift({ id: itemId, date: new Date().toISOString(), item });
                        if (state.viewHistory.length > 20) state.viewHistory.pop();
                    }
                    
                    let content = '';
                    if (item.type === 'job') {
                        const isFav = state.favorites.has(item.id);
                        content = `<div class="p-6">
                            <div class="flex items-start gap-4 mb-6">
                                ${item.logo ? `<img src="${item.logo}" alt="${item.company}" class="w-20 h-20 rounded-lg shadow">` : ''}
                                <div class="flex-1">
                                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">${item.title}</h2>
                                    <p class="text-xl text-gray-600 dark:text-gray-300">${item.company}</p>
                                    <div class="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400 flex-wrap">
                                        <span><i class="fas fa-map-marker-alt mr-1"></i>${item.city}</span>
                                        <span><i class="fas fa-briefcase mr-1"></i>${item.contract}</span>
                                        <span><i class="fas fa-laptop-house mr-1"></i>${item.workArrangement}</span>
                                        <span><i class="fas fa-euro-sign mr-1"></i>${item.salary?.toLocaleString('fr-FR')} €/an</span>
                                        ${item.industry ? `<span class="bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-2 py-1 rounded text-xs"><i class="fas fa-industry mr-1"></i>${item.industry}</span>` : ''}
                                    </div>
                                </div>
                                <button class="favorite-icon p-3 text-2xl ${isFav ? 'text-pink-500' : 'text-gray-300'} hover:text-pink-500" data-id="${item.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                            
                            ${item.companyDescription ? `<div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2 dark:text-white">À propos de l'entreprise</h3>
                                <p class="text-gray-700 dark:text-gray-300">${item.companyDescription}</p>
                            </div>` : ''}
                            
                            <div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2 dark:text-white">Description du poste</h3>
                                <p class="text-gray-700 dark:text-gray-300">${item.description}</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h3 class="font-semibold text-lg mb-2 dark:text-white">Compétences techniques requises</h3>
                                    <div class="flex flex-wrap gap-2">
                                        ${item.tags.map(tag => `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg mb-2 dark:text-white">Compétences comportementales</h3>
                                    <div class="flex flex-wrap gap-2">
                                        ${item.softSkills?.map(skill => `<span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-3 py-1 rounded-full text-sm">${skill}</span>`).join('') || '<span class="text-gray-500">Non spécifié</span>'}
                                    </div>
                                </div>
                            </div>
                            
                            ${item.acceptsSpontaneous ? `<div class="mb-4 p-3 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-700">
                                <p class="text-sm text-indigo-700 dark:text-indigo-300"><i class="fas fa-star mr-2"></i>Cette entreprise accepte les <strong>candidatures spontanées</strong></p>
                            </div>` : ''}
                            
                            <div class="flex gap-3 mt-6">
                                ${state.currentUser?.type === 'candidate' ? `<button onclick="applyToJob(${item.id})" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-paper-plane mr-2"></i>Postuler
                                </button>` : ''}
                                <button onclick="showCompanyProfile('${item.company}')" class="flex-1 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition">
                                    <i class="fas fa-building mr-2"></i>Entreprise
                                </button>
                                <button onclick="calculateRoute({lat: ${state.userLocation.lat}, lon: ${state.userLocation.lon}}, {lat: ${item.location.lat}, lon: ${item.location.lon}}); closeAllModals();" class="flex-1 bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition">
                                    <i class="fas fa-route mr-2"></i>Voir l'itinéraire
                                </button>
                                <button class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition" onclick="shareItem(${item.id})">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>`;
                    } else if (item.type === 'candidate') {
                        const isFav = state.favorites.has(item.id);
                        content = `<div class="p-6">
                            <div class="flex items-start gap-4 mb-6">
                                ${item.avatar ? `<img src="${item.avatar}" alt="${item.name}" class="w-20 h-20 rounded-full shadow">` : ''}
                                <div class="flex-1">
                                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">${item.name}</h2>
                                    <p class="text-xl text-gray-600 dark:text-gray-300">${item.title}</p>
                                    <div class="flex items-center gap-4 mt-2 text-sm text-gray-500 dark:text-gray-400">
                                        <span><i class="fas fa-map-marker-alt mr-1"></i>${item.city}</span>
                                        <span><i class="fas fa-briefcase mr-1"></i>${item.experience}</span>
                                        <span><i class="fas fa-clock mr-1"></i>Disponibilité: ${item.availability || 'À négocier'}</span>
                                    </div>
                                </div>
                                <button class="favorite-icon p-3 text-2xl ${isFav ? 'text-pink-500' : 'text-gray-300'} hover:text-pink-500" data-id="${item.id}">
                                    <i class="fas fa-heart"></i>
                                </button>
                            </div>
                            
                            <div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2 dark:text-white">À propos</h3>
                                <p class="text-gray-700 dark:text-gray-300">${item.description}</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div>
                                    <h3 class="font-semibold text-lg mb-2 dark:text-white">Compétences techniques</h3>
                                    <div class="flex flex-wrap gap-2">
                                        ${item.tags.map(tag => `<span class="bg-emerald-100 dark:bg-emerald-900 text-emerald-800 dark:text-emerald-200 px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-lg mb-2 dark:text-white">Compétences comportementales</h3>
                                    <div class="flex flex-wrap gap-2">
                                        ${item.softSkills?.map(skill => `<span class="bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 px-3 py-1 rounded-full text-sm">${skill}</span>`).join('') || '<span class="text-gray-500">Non spécifié</span>'}
                                    </div>
                                </div>
                            </div>
                            
                            ${item.background ? `<div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2 dark:text-white">Parcours professionnel</h3>
                                <div class="space-y-3">
                                    ${item.background.map(bg => `<div class="border-l-4 border-blue-500 pl-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-r">
                                        <p class="font-semibold dark:text-white">${bg.role}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${bg.company} • ${bg.year}</p>
                                    </div>`).join('')}
                                </div>
                            </div>` : ''}
                            
                            ${item.education ? `<div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2 dark:text-white"><i class="fas fa-graduation-cap mr-2"></i>Formation</h3>
                                <div class="space-y-3">
                                    ${item.education.map(edu => `<div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 dark:bg-gray-700 rounded-r">
                                        <p class="font-semibold dark:text-white">${edu.degree}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">${edu.school} • ${edu.year}</p>
                                    </div>`).join('')}
                                </div>
                            </div>` : ''}
                            
                            ${item.certifications && item.certifications.length > 0 ? `<div class="mb-6">
                                <h3 class="font-semibold text-lg mb-2 dark:text-white"><i class="fas fa-certificate mr-2"></i>Certifications</h3>
                                <div class="flex flex-wrap gap-2">
                                    ${item.certifications.map(cert => `<span class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-3 py-2 rounded-lg text-sm flex items-center gap-2"><i class="fas fa-award"></i>${cert}</span>`).join('')}
                                </div>
                            </div>` : ''}
                            
                            <div class="flex gap-3 mt-6">
                                ${state.currentUser?.type === 'recruiter' ? `<button onclick="contactCandidate(${item.id})" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">
                                    <i class="fas fa-envelope mr-2"></i>Contacter
                                </button>` : ''}
                                ${item.portfolioLink ? `<a href="${item.portfolioLink}" target="_blank" class="flex-1 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition text-center">
                                    <i class="fas fa-external-link-alt mr-2"></i>Portfolio
                                </a>` : ''}
                                <button onclick="calculateRoute({lat: ${state.userLocation.lat}, lon: ${state.userLocation.lon}}, {lat: ${item.location.lat}, lon: ${item.location.lon}}); closeAllModals();" class="flex-1 bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-emerald-700 transition">
                                    <i class="fas fa-route mr-2"></i>Itinéraire
                                </button>
                                <button class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition" onclick="shareItem(${item.id})">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                            </div>
                        </div>`;
                    }
                    
                    document.getElementById('details-modal-content').innerHTML = content;
                    openModal('details-modal');
                }

                function handleMatchClick(item) {
                    if (!state.isMatchModeActive) return;
                    if (!state.matchStartPoint) {
                        if (item.type === 'candidate') {
                            state.matchStartPoint = item; state.markers.get(item.id)?._icon.classList.add('pulsing'); showToast(`${item.name} sélectionné. Choisissez une offre.`, 'info');
                        } else { showToast("Veuillez d'abord sélectionner un candidat.", 'error'); }
                    } else {
                        if (item.type === 'job') { calculateAndShowMatchReport(state.matchStartPoint, item); toggleMatchMode(); } 
                        else if (item.id === state.matchStartPoint.id) { toggleMatchMode(); } 
                        else { showToast("Veuillez sélectionner une offre d'emploi.", 'error'); }
                    }
                }
                
                function applyToJob(jobId) {
                    if (!state.currentUser) { showToast('Connectez-vous pour postuler.', 'error'); openModal('login-modal'); return; }
                    const job = data.find(j => j.id === jobId);
                    if (!job) return;
                    if (!state.applications) state.applications = [];
                    if (state.applications.some(a => a.jobId === jobId && a.candidateId === state.currentUser.id)) {
                        showToast('Vous avez déjà postulé à cette offre.', 'info');
                        return;
                    }
                    state.applications.push({ id: state.applications.length + 1, jobId, candidateId: state.currentUser.id, date: new Date().toISOString(), status: 'pending' });
                    showToast(`Candidature envoyée pour ${job.title} !`, 'success');
                    closeAllModals();
                }
                
                function contactCandidate(candidateId) {
                    if (!state.currentUser) { showToast('Connectez-vous pour contacter un candidat.', 'error'); openModal('login-modal'); return; }
                    const candidate = data.find(c => c.id === candidateId);
                    if (!candidate) return;
                    showToast(`Message envoyé à ${candidate.name} !`, 'success');
                    closeAllModals();
                }
                
                function shareItem(itemId) {
                    const item = data.find(d => d.id === itemId);
                    if (!item) return;
                    const url = `${window.location.href}?item=${itemId}`;
                    const text = item.type === 'job' ? `${item.title} chez ${item.company}` : `Profil de ${item.name} - ${item.title}`;
                    if (navigator.share) {
                        navigator.share({ title: 'JobMap by LTd', text, url }).then(() => showToast('Partagé !', 'success')).catch(() => {});
                    } else {
                        navigator.clipboard.writeText(url).then(() => showToast('Lien copié dans le presse-papier !', 'success'));
                    }
                }
                
                function showFavoritesModal() {
                    const favoriteItems = data.filter(item => state.favorites.has(item.id));
                    let content = '';
                    if (favoriteItems.length === 0) {
                        content = '<p class="text-center text-gray-500 py-8">Aucun favori pour le moment.</p>';
                    } else {
                        content = '<div class="space-y-3">';
                        favoriteItems.forEach(item => {
                            content += `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1 cursor-pointer" onclick="showDetailsModal(${item.id})">
                                        <h3 class="font-semibold text-lg dark:text-white">${item.title || item.name}</h3>
                                        <p class="text-gray-600 dark:text-gray-300">${item.type === 'job' ? item.company : item.title}</p>
                                        <div class="flex items-center gap-3 mt-2 text-sm text-gray-500">
                                            <span><i class="fas fa-map-marker-alt mr-1"></i>${item.city}</span>
                                            ${item.type === 'job' ? `<span><i class="fas fa-euro-sign mr-1"></i>${item.salary?.toLocaleString('fr-FR')} €</span>` : ''}
                                        </div>
                                    </div>
                                    <button class="favorite-icon p-2 text-pink-500 hover:text-pink-600" data-id="${item.id}">
                                        <i class="fas fa-heart"></i>
                                    </button>
                                </div>
                            </div>`;
                        });
                        content += '</div>';
                    }
                    document.getElementById('favorites-list').innerHTML = content;
                    openModal('favorites-modal');
                }
                
                function getUserLocation() {
                    if (navigator.geolocation) {
                        showToast('Localisation en cours...', 'info');
                        navigator.geolocation.getCurrentPosition(position => {
                            state.userLocation = { lat: position.coords.latitude, lon: position.coords.longitude };
                            if (state.userLocationMarker) map.removeLayer(state.userLocationMarker);
                            const icon = L.divIcon({ className: '', html: '<div class="user-location-icon"></div>', iconSize: [18, 18], iconAnchor: [9, 9] });
                            state.userLocationMarker = L.marker([state.userLocation.lat, state.userLocation.lon], { icon }).addTo(map);
                            map.setView([state.userLocation.lat, state.userLocation.lon], 12);
                            showToast('Position trouvée !', 'success');
                        }, () => showToast('Impossible de vous localiser.', 'error'));
                    } else {
                        showToast('Géolocalisation non supportée.', 'error');
                    }
                }
                
                function saveCurrentSearch() {
                    const searchName = prompt('Nom de la recherche :');
                    if (!searchName) return;
                    state.savedSearches.push({
                        id: state.savedSearches.length + 1,
                        name: searchName,
                        query: ui.searchInput.value,
                        filters: { ...state.filters },
                        date: new Date().toISOString()
                    });
                    showToast('Recherche sauvegardée !', 'success');
                }
                
                function showSavedSearches() {
                    let content = '';
                    if (state.savedSearches.length === 0) {
                        content = `<p class="text-center text-gray-500 py-8">Aucune recherche sauvegardée.</p>
                            <div class="text-center mt-4">
                                <button onclick="saveCurrentSearch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-save mr-2"></i>Sauvegarder la recherche actuelle
                                </button>
                            </div>`;
                    } else {
                        content = `<div class="space-y-3 mb-4">
                            ${state.savedSearches.map(search => `
                                <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h4 class="font-semibold dark:text-white">${search.name}</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">
                                                ${search.query ? `Recherche: "${search.query}"` : 'Tous les résultats'} • 
                                                Type: ${search.filters.type === 'all' ? 'Tous' : search.filters.type === 'job' ? 'Emplois' : 'Candidats'}
                                            </p>
                                            <p class="text-xs text-gray-500 mt-1">${new Date(search.date).toLocaleDateString('fr-FR')}</p>
                                        </div>
                                        <button onclick="loadSavedSearch(${search.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm">
                                            <i class="fas fa-search mr-1"></i>Charger
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center">
                            <button onclick="saveCurrentSearch()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-save mr-2"></i>Sauvegarder la recherche actuelle
                            </button>
                        </div>`;
                    }
                    
                    const modal = document.createElement('div');
                    modal.id = 'saved-searches-modal';
                    modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 z-[1050] flex items-center justify-center';
                    modal.innerHTML = `<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 transform max-h-[90vh] flex flex-col">
                        <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button>
                        <div class="overflow-y-auto p-8">
                            <h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Recherches sauvegardées</h2>
                            ${content}
                        </div>
                    </div>`;
                    ui.modalContainer.appendChild(modal);
                    setTimeout(() => modal.querySelector('.modal-panel').classList.remove('hidden'), 10);
                }
                
                function loadSavedSearch(searchId) {
                    const search = state.savedSearches.find(s => s.id === searchId);
                    if (!search) return;
                    ui.searchInput.value = search.query || '';
                    state.filters = { ...search.filters };
                    performSearch();
                    closeAllModals();
                    showToast('Recherche chargée !', 'success');
                }
                
                function showViewHistory() {
                    let content = '';
                    if (state.viewHistory.length === 0) {
                        content = '<p class="text-center text-gray-500 py-8">Aucun historique de consultation.</p>';
                    } else {
                        content = `<div class="space-y-3">
                            ${state.viewHistory.map(entry => {
                                const item = entry.item;
                                return `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:shadow-md transition" onclick="showDetailsModal(${item.id})">
                                    <div class="flex items-start gap-3">
                                        ${item.avatar || item.logo ? `<img src="${item.avatar || item.logo}" class="w-12 h-12 rounded-${item.type === 'candidate' ? 'full' : 'lg'}">` : ''}
                                        <div class="flex-1">
                                            <h4 class="font-semibold dark:text-white">${item.type === 'job' ? item.title : item.name}</h4>
                                            <p class="text-sm text-gray-600 dark:text-gray-300">${item.type === 'job' ? item.company : item.title}</p>
                                            <div class="flex items-center gap-3 mt-1 text-xs text-gray-500">
                                                <span><i class="fas fa-map-marker-alt mr-1"></i>${item.city}</span>
                                                <span><i class="fas fa-clock mr-1"></i>${new Date(entry.date).toLocaleString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</span>
                                            </div>
                                        </div>
                                        <span class="px-2 py-1 rounded text-xs ${item.type === 'job' ? 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200' : 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200'}">
                                            ${item.type === 'job' ? 'Emploi' : 'Candidat'}
                                        </span>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>`;
                    }
                    
                    const modal = document.createElement('div');
                    modal.id = 'history-modal';
                    modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 z-[1050] flex items-center justify-center';
                    modal.innerHTML = `<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 transform max-h-[90vh] flex flex-col">
                        <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button>
                        <div class="overflow-y-auto p-8">
                            <h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Historique de consultation</h2>
                            ${content}
                        </div>
                    </div>`;
                    ui.modalContainer.appendChild(modal);
                    setTimeout(() => modal.querySelector('.modal-panel').classList.remove('hidden'), 10);
                }
                
                function showHelp() {
                    const content = `<div class="space-y-6">
                        <div class="text-center mb-4">
                            <i class="fas fa-map-marked-alt text-6xl text-blue-500 mb-4"></i>
                            <h3 class="text-2xl font-bold dark:text-white">Bienvenue sur JobMap by LTd</h3>
                            <p class="text-gray-600 dark:text-gray-300 mt-2">Votre plateforme de mise en relation emploi géolocalisée</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-search text-2xl text-blue-600 dark:text-blue-400"></i>
                                    <h4 class="font-semibold dark:text-white">Recherche</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Utilisez la barre de recherche pour trouver des emplois ou candidats par compétences, ville ou poste.</p>
                            </div>
                            
                            <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-filter text-2xl text-green-600 dark:text-green-400"></i>
                                    <h4 class="font-semibold dark:text-white">Filtres avancés</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Affinez votre recherche avec les filtres : expérience, salaire, distance, type de contrat...</p>
                            </div>
                            
                            <div class="p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-link text-2xl text-purple-600 dark:text-purple-400"></i>
                                    <h4 class="font-semibold dark:text-white">Mode Association</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Sélectionnez un candidat puis une offre pour voir un rapport de compatibilité détaillé.</p>
                            </div>
                            
                            <div class="p-4 bg-pink-50 dark:bg-pink-900/20 rounded-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-heart text-2xl text-pink-600 dark:text-pink-400"></i>
                                    <h4 class="font-semibold dark:text-white">Favoris</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Ajoutez des offres ou profils à vos favoris pour les retrouver facilement.</p>
                            </div>
                            
                            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-crosshairs text-2xl text-yellow-600 dark:text-yellow-400"></i>
                                    <h4 class="font-semibold dark:text-white">Géolocalisation</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Cliquez sur le bouton de géolocalisation pour centrer la carte sur votre position.</p>
                            </div>
                            
                            <div class="p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-route text-2xl text-orange-600 dark:text-orange-400"></i>
                                    <h4 class="font-semibold dark:text-white">Itinéraires</h4>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300">Calculez l'itinéraire vers une offre d'emploi ou un candidat depuis votre position.</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 p-6 rounded-lg">
                            <h4 class="font-semibold text-lg mb-3 dark:text-white">Fonctionnalités Premium</h4>
                            <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Sauvegarde de recherches personnalisées</li>
                                <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Historique de consultation</li>
                                <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Notifications en temps réel</li>
                                <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Export de données en CSV</li>
                                <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Tableau de bord avec statistiques</li>
                                <li><i class="fas fa-check-circle text-green-500 mr-2"></i>Système de candidature intégré</li>
                            </ul>
                        </div>
                    </div>`;
                    
                    const modal = document.createElement('div');
                    modal.id = 'help-modal';
                    modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 z-[1050] flex items-center justify-center';
                    modal.innerHTML = `<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl m-4 transform max-h-[90vh] flex flex-col">
                        <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button>
                        <div class="overflow-y-auto p-8">
                            <h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Guide d'utilisation</h2>
                            ${content}
                        </div>
                    </div>`;
                    ui.modalContainer.appendChild(modal);
                    setTimeout(() => modal.querySelector('.modal-panel').classList.remove('hidden'), 10);
                }
                
                function showCompanyProfile(companyName) {
                    const companyJobs = data.filter(j => j.type === 'job' && j.company === companyName);
                    if (companyJobs.length === 0) return;
                    
                    const company = companyJobs[0];
                    const rating = 4.5;
                    const reviews = Math.floor(Math.random() * 50) + 20;
                    
                    const content = `<div class="space-y-6">
                        <div class="text-center">
                            ${company.logo ? `<img src="${company.logo}" class="w-24 h-24 mx-auto rounded-lg shadow-lg mb-4">` : ''}
                            <h2 class="text-3xl font-bold dark:text-white">${companyName}</h2>
                            <div class="flex items-center justify-center gap-2 mt-2">
                                ${[1,2,3,4,5].map(i => `<i class="fas fa-star ${i <= Math.floor(rating) ? 'text-yellow-400' : 'text-gray-300'}"></i>`).join('')}
                                <span class="text-gray-600 dark:text-gray-400 ml-2">${rating.toFixed(1)} (${reviews} avis)</span>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-6 rounded-lg">
                            <h3 class="font-semibold text-lg mb-2 dark:text-white">À propos</h3>
                            <p class="text-gray-700 dark:text-gray-300">${company.companyDescription}</p>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-lg mb-4 dark:text-white">Offres d'emploi actives (${companyJobs.length})</h3>
                            <div class="space-y-3">
                                ${companyJobs.map(job => `
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:shadow-md transition" onclick="showDetailsModal(${job.id})">
                                        <h4 class="font-semibold dark:text-white">${job.title}</h4>
                                        <div class="flex items-center gap-4 mt-2 text-sm text-gray-600 dark:text-gray-300">
                                            <span><i class="fas fa-map-marker-alt mr-1"></i>${job.city}</span>
                                            <span><i class="fas fa-briefcase mr-1"></i>${job.contract}</span>
                                            <span><i class="fas fa-euro-sign mr-1"></i>${job.salary?.toLocaleString('fr-FR')} €</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-lg mb-4 dark:text-white">Avis des employés</h3>
                            <div class="space-y-3">
                                ${[
                                    { author: 'Sophie M.', rating: 5, comment: 'Excellente ambiance de travail, équipe dynamique et projets stimulants.', date: '2024-01-15' },
                                    { author: 'Marc D.', rating: 4, comment: 'Bonne entreprise avec de belles opportunités d\'évolution.', date: '2023-12-20' },
                                    { author: 'Julie R.', rating: 5, comment: 'Management à l\'écoute et très bons avantages sociaux.', date: '2023-11-10' }
                                ].map(review => `
                                    <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold dark:text-white">${review.author}</span>
                                            <div class="flex items-center gap-1">
                                                ${[1,2,3,4,5].map(i => `<i class="fas fa-star text-xs ${i <= review.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`).join('')}
                                            </div>
                                        </div>
                                        <p class="text-sm text-gray-700 dark:text-gray-300">${review.comment}</p>
                                        <p class="text-xs text-gray-500 mt-2">${new Date(review.date).toLocaleDateString('fr-FR')}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${state.currentUser ? `<div class="text-center">
                            <button onclick="leaveReview('${companyName}')" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                                <i class="fas fa-comment-dots mr-2"></i>Laisser un avis
                            </button>
                        </div>` : ''}
                    </div>`;
                    
                    document.getElementById('company-profile-content').innerHTML = content;
                    openModal('company-modal');
                }
                
                function leaveReview(companyName) {
                    const rating = prompt(`Note pour ${companyName} (1-5) :`);
                    if (!rating || rating < 1 || rating > 5) return;
                    const comment = prompt('Votre commentaire :');
                    if (!comment) return;
                    showToast('Avis publié avec succès !', 'success');
                    closeAllModals();
                }

                function performSearch() {
                    state.firstInteraction = true;
                    const query = ui.searchInput.value.toLowerCase();
                    
                    const calculateDistance = (lat1, lon1, lat2, lon2) => {
                        const R = 6371; // Earth radius in km
                        const dLat = (lat2 - lat1) * Math.PI / 180;
                        const dLon = (lon2 - lon1) * Math.PI / 180;
                        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
                        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        return R * c;
                    };
                    
                    const filteredData = data.filter(item => {
                        const typeMatch = state.filters.type === 'all' || item.type === state.filters.type;
                        const expMatch = state.filters.experience === 'all' || (item.experience && item.experience === state.filters.experience);
                        const salaryMatch = item.type === 'candidate' || (item.salary && item.salary <= state.filters.salary);
                        const contractMatch = state.filters.contract === 'all' || (item.type === 'candidate' || (item.contract && item.contract === state.filters.contract));
                        const workArrangementMatch = state.filters.workArrangement === 'all' || (item.type === 'candidate' || (item.workArrangement && (item.workArrangement.includes(state.filters.workArrangement))));
                        const industryMatch = state.filters.industry === 'all' || (item.type === 'candidate' || (item.industry && item.industry === state.filters.industry));
                        const distance = calculateDistance(state.userLocation.lat, state.userLocation.lon, item.location.lat, item.location.lon);
                        const distanceMatch = distance <= state.filters.distance;
                        const queryMatch = !query || Object.values(item).some(val => String(val).toLowerCase().includes(query)) || (item.tags && item.tags.some(tag => tag.toLowerCase().includes(query)));
                        return typeMatch && expMatch && salaryMatch && contractMatch && workArrangementMatch && industryMatch && distanceMatch && queryMatch;
                    });
                    displayData(filteredData);
                }
                
                function exportData() {
                    const query = ui.searchInput.value.toLowerCase();
                    const filteredData = data.filter(item => {
                        const typeMatch = state.filters.type === 'all' || item.type === state.filters.type;
                        return typeMatch;
                    });
                    
                    const csvContent = "data:text/csv;charset=utf-8," + 
                        "Type,Titre/Nom,Entreprise/Fonction,Ville,Compétences,Expérience\n" +
                        filteredData.map(item => {
                            const type = item.type === 'job' ? 'Emploi' : 'Candidat';
                            const name = item.type === 'job' ? item.title : item.name;
                            const company = item.type === 'job' ? item.company : item.title;
                            const skills = item.tags.join('; ');
                            return `"${type}","${name}","${company}","${item.city}","${skills}","${item.experience}"`;
                        }).join("\n");
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `jobmap_export_${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('Données exportées !', 'success');
                }

                function displayData(filteredData) {
                    markerClusters.clearLayers(); state.markers.clear(); ui.resultsList.innerHTML = '';
                    const showList = state.firstInteraction;
                    ui.resultsHeader.classList.toggle('hidden', !showList); ui.resultsList.classList.toggle('hidden', !showList);
                    ui.resultsCount.textContent = `${filteredData.length} résultat(s)`;
                    if (filteredData.length === 0 && showList) { ui.resultsList.innerHTML = `<p class="text-center text-gray-500 p-4">Aucun résultat trouvé.</p>`; return; }
                    filteredData.forEach(item => {
                        const markerHtml = `<div class="custom-marker-icon w-8 h-8 ${item.type === 'job' ? 'bg-blue-500' : 'bg-emerald-500'}"><i class="fas ${item.type === 'job' ? 'fa-briefcase' : 'fa-user'}"></i></div>`;
                        const icon = L.divIcon({ className: '', html: markerHtml, iconSize: [32, 32], iconAnchor: [16, 16] });
                        const marker = L.marker([item.location.lat, item.location.lon], { icon: icon });
                        marker.on('click', () => handleMatchClick(item));
                        marker.bindPopup(`<div class="popup-title">${item.title}</div><div class="popup-company">${item.type === 'job' ? item.company : item.name}</div><button class="view-details-btn bg-blue-500 text-white text-xs font-bold py-1 px-3 rounded-full w-full" data-id="${item.id}">Voir détails</button>`);
                        markerClusters.addLayer(marker); state.markers.set(item.id, marker);
                        if(showList) {
                            const isFav = state.favorites.has(item.id);
                            ui.resultsList.innerHTML += `<div class="result-card bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-md dark:hover:bg-gray-700 transition flex justify-between items-start ${item.type === 'job' ? 'border-l-4 border-blue-500' : 'border-l-4 border-emerald-500'}"><div class="cursor-pointer flex-grow" data-id="${item.id}" data-lat="${item.location.lat}" data-lon="${item.location.lon}"><h3 class="text-gray-800 dark:text-gray-100">${item.title}</h3><p class="text-gray-600 dark:text-gray-300">${item.type === 'job' ? item.company : item.name}</p><p class="text-gray-400 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${item.city}</p></div><button class="favorite-icon p-2 text-gray-300 dark:text-gray-500 hover:text-pink-500 ${isFav ? 'is-favorite' : ''}" data-id="${item.id}"><i class="fas fa-heart"></i></button></div>`;
                        }
                    });
                }
                
                document.addEventListener('click', e => {
                    const closeModalBtn = e.target.closest('.close-modal-btn');
                    if (closeModalBtn) { e.preventDefault(); closeAllModals(); return; }
                    const actionTarget = e.target.closest('[data-action]');
                    if (actionTarget) {
                        e.preventDefault(); const { action } = actionTarget.dataset;
                        switch(action) {
                            case 'login': openModal('login-modal'); break;
                            case 'signup-candidate': openModal('signupCandidate-modal'); break;
                            case 'signup-recruiter': openModal('signupRecruiter-modal'); break;
                            case 'signup-employer': openModal('signupEmployer-modal'); break;
                            case 'post-job': openModal('postJob-modal'); break;
                            case 'edit-profile': 
                                const form = document.getElementById('edit-profile-form');
                                const user = data.find(u => u.id === state.currentUser.id);
                                form.innerHTML = `<input name="title" value="${user.title}" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Titre"><textarea name="description" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Description">${user.description || ''}</textarea><input name="tags" value="${user.tags.join(', ')}" class="w-full p-2 border rounded dark:bg-gray-700" placeholder="Compétences"><button type="submit" class="w-full bg-blue-600 text-white p-2 rounded mt-4">Sauvegarder</button>`;
                                document.getElementById('edit-profile-form').addEventListener('submit', e => {
                                    e.preventDefault();
                                    user.title = e.target.title.value;
                                    user.description = e.target.description.value;
                                    user.tags = e.target.tags.value.split(',').map(t => t.trim());
                                    closeAllModals();
                                    showToast('Profil mis à jour !', 'success');
                                    performSearch();
                                });
                                openModal('editProfile-modal'); 
                                break;
                            case 'logout': state.currentUser = null; updateAuthUI(); showToast('Déconnecté.', 'info'); break;
                            case 'dashboard': showDashboard(); break;
                            case 'notifications': showNotifications(); break;
                            case 'saved-searches': showSavedSearches(); break;
                            case 'view-history': showViewHistory(); break;
                            case 'show-company': openModal('company-modal'); break;
                            case 'spontaneous-application': openModal('spontaneousApplication-modal'); break;
                            case 'messages': showMessages(); break;
                            case 'job-alerts': showJobAlerts(); break;
                            case 'salary-insights': showSalaryInsights(); break;
                        }
                        return;
                    }
                    if (e.target.closest('.favorite-icon')) { toggleFavorite(parseInt(e.target.closest('.favorite-icon').dataset.id)); }
                });
                
                function showNotifications() {
                    const notifications = [
                        { id: 1, type: 'success', icon: 'fa-check-circle', title: 'Candidature envoyée', message: 'Votre candidature pour Développeur Full-Stack a été envoyée avec succès.', date: new Date(Date.now() - 3600000).toISOString() },
                        { id: 2, type: 'info', icon: 'fa-eye', title: 'Profil consulté', message: 'Votre profil a été consulté par Tech Solutions Inc.', date: new Date(Date.now() - 86400000).toISOString() },
                        { id: 3, type: 'warning', icon: 'fa-star', title: 'Nouvelle offre correspondante', message: 'Une nouvelle offre correspond à votre profil: Data Scientist Senior.', date: new Date(Date.now() - 172800000).toISOString() }
                    ];
                    
                    const content = `<div class="space-y-3">
                        ${notifications.map(notif => {
                            const colors = { success: 'bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400', info: 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400', warning: 'bg-yellow-50 dark:bg-yellow-900/20 text-yellow-600 dark:text-yellow-400' };
                            return `<div class="p-4 ${colors[notif.type]} rounded-lg">
                                <div class="flex items-start gap-3">
                                    <i class="fas ${notif.icon} text-2xl mt-1"></i>
                                    <div class="flex-1">
                                        <h4 class="font-semibold">${notif.title}</h4>
                                        <p class="text-sm mt-1">${notif.message}</p>
                                        <p class="text-xs mt-2 opacity-75">${new Date(notif.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>`;
                    
                    const modal = document.createElement('div');
                    modal.id = 'notifications-modal';
                    modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 z-[1050] flex items-center justify-center';
                    modal.innerHTML = `<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl m-4 transform max-h-[90vh] flex flex-col">
                        <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button>
                        <div class="overflow-y-auto p-8">
                            <h2 class="text-2xl font-bold text-center mb-6 dark:text-white">Notifications</h2>
                            ${content}
                        </div>
                    </div>`;
                    ui.modalContainer.appendChild(modal);
                    setTimeout(() => modal.querySelector('.modal-panel').classList.remove('hidden'), 10);
                }
                
                function showMessages() {
                    const messages = [
                        { id: 1, from: 'Tech Solutions Inc.', subject: 'Réponse à votre candidature', preview: 'Nous avons bien reçu votre candidature et souhaitons vous rencontrer...', date: new Date(Date.now() - 86400000).toISOString(), unread: true },
                        { id: 2, from: 'DataCorp', subject: 'Opportunité de poste', preview: 'Votre profil nous intéresse pour un poste de Data Scientist...', date: new Date(Date.now() - 172800000).toISOString(), unread: false },
                        { id: 3, from: 'AppFactory', subject: 'Entretien technique', preview: 'Suite à votre candidature, nous souhaitons organiser un entretien...', date: new Date(Date.now() - 259200000).toISOString(), unread: false }
                    ];
                    
                    const content = `<div class="space-y-2">
                        ${messages.map(msg => `<div class="p-4 ${msg.unread ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-gray-50 dark:bg-gray-700'} rounded-lg hover:shadow-md transition cursor-pointer">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        ${msg.unread ? '<span class="w-2 h-2 bg-blue-500 rounded-full"></span>' : ''}
                                        <h4 class="font-semibold dark:text-white">${msg.from}</h4>
                                    </div>
                                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300 mt-1">${msg.subject}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${msg.preview}</p>
                                </div>
                                <span class="text-xs text-gray-500 dark:text-gray-400">${new Date(msg.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })}</span>
                            </div>
                        </div>`).join('')}
                    </div>`;
                    
                    document.getElementById('messages-content').innerHTML = content;
                    openModal('messages-modal');
                }
                
                function showJobAlerts() {
                    const alerts = [
                        { id: 1, title: 'Développeur Full-Stack', keywords: ['React', 'Node.js', 'TypeScript'], location: 'Paris', frequency: 'Quotidien', active: true, matches: 5 },
                        { id: 2, title: 'Data Scientist', keywords: ['Python', 'Machine Learning'], location: 'Lyon', frequency: 'Hebdomadaire', active: true, matches: 2 },
                        { id: 3, title: 'DevOps Engineer', keywords: ['Docker', 'Kubernetes', 'AWS'], location: 'Télétravail', frequency: 'Quotidien', active: false, matches: 0 }
                    ];
                    
                    const content = `<div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                            <p class="text-sm text-gray-700 dark:text-gray-300"><i class="fas fa-info-circle mr-2"></i>Recevez des notifications lorsque de nouvelles offres correspondent à vos critères.</p>
                        </div>
                        ${alerts.map(alert => `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-semibold dark:text-white">${alert.title}</h4>
                                        <span class="px-2 py-1 text-xs rounded-full ${alert.active ? 'bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300' : 'bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300'}">${alert.active ? 'Actif' : 'Inactif'}</span>
                                    </div>
                                    <div class="mt-2 flex flex-wrap gap-1">
                                        ${alert.keywords.map(kw => `<span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded text-xs">${kw}</span>`).join('')}
                                    </div>
                                    <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                        <i class="fas fa-map-marker-alt mr-1"></i>${alert.location} • ${alert.frequency} • ${alert.matches} nouvelle(s) offre(s)
                                    </div>
                                </div>
                                <button class="text-blue-600 hover:text-blue-700 dark:text-blue-400"><i class="fas fa-cog"></i></button>
                            </div>
                        </div>`).join('')}
                        <button class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i class="fas fa-plus mr-2"></i>Créer une nouvelle alerte
                        </button>
                    </div>`;
                    
                    document.getElementById('job-alerts-content').innerHTML = content;
                    openModal('jobAlerts-modal');
                }
                
                function showSalaryInsights() {
                    const jobs = data.filter(item => item.type === 'job' && item.salary);
                    const industries = {};
                    const experiences = { 'Junior': [], 'Confirmé': [], 'Senior': [] };
                    
                    jobs.forEach(job => {
                        if (job.industry) {
                            if (!industries[job.industry]) industries[job.industry] = [];
                            industries[job.industry].push(job.salary);
                        }
                        if (job.experience && experiences[job.experience]) {
                            experiences[job.experience].push(job.salary);
                        }
                    });
                    
                    const avgBySector = Object.keys(industries).map(sector => ({
                        sector,
                        avg: Math.round(industries[sector].reduce((a,b) => a+b, 0) / industries[sector].length),
                        min: Math.min(...industries[sector]),
                        max: Math.max(...industries[sector]),
                        count: industries[sector].length
                    })).sort((a,b) => b.avg - a.avg);
                    
                    const avgByExp = Object.keys(experiences).map(level => ({
                        level,
                        avg: experiences[level].length > 0 ? Math.round(experiences[level].reduce((a,b) => a+b, 0) / experiences[level].length) : 0,
                        count: experiences[level].length
                    })).filter(e => e.count > 0);
                    
                    const content = `<div class="space-y-6">
                        <div class="bg-gradient-to-r from-teal-50 to-blue-50 dark:from-teal-900/20 dark:to-blue-900/20 p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-2 dark:text-white"><i class="fas fa-chart-line mr-2"></i>Baromètre des Salaires 2024</h3>
                            <p class="text-sm text-gray-700 dark:text-gray-300">Données basées sur ${jobs.length} offres d'emploi récentes</p>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-lg mb-4 dark:text-white">Salaires moyens par expérience</h4>
                            <div class="space-y-3">
                                ${avgByExp.map(exp => {
                                    const colors = { 'Junior': 'bg-green-100 dark:bg-green-900/40', 'Confirmé': 'bg-blue-100 dark:bg-blue-900/40', 'Senior': 'bg-purple-100 dark:bg-purple-900/40' };
                                    const percentage = (exp.avg / Math.max(...avgByExp.map(e => e.avg))) * 100;
                                    return `<div class="p-4 ${colors[exp.level]} rounded-lg">
                                        <div class="flex justify-between items-center mb-2">
                                            <span class="font-semibold dark:text-white">${exp.level}</span>
                                            <span class="text-xl font-bold text-blue-600 dark:text-blue-400">${exp.avg.toLocaleString('fr-FR')} €/an</span>
                                        </div>
                                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                        <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${exp.count} offres analysées</p>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-lg mb-4 dark:text-white">Salaires moyens par secteur</h4>
                            <div class="space-y-3">
                                ${avgBySector.map(sector => {
                                    return `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <div class="flex-1">
                                                <h5 class="font-semibold dark:text-white">${sector.sector}</h5>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">Min: ${sector.min.toLocaleString('fr-FR')}€ • Max: ${sector.max.toLocaleString('fr-FR')}€</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-xl font-bold text-teal-600 dark:text-teal-400">${sector.avg.toLocaleString('fr-FR')}€</p>
                                                <p class="text-xs text-gray-500 dark:text-gray-400">${sector.count} offres</p>
                                            </div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                            <p class="text-sm text-gray-700 dark:text-gray-300"><i class="fas fa-lightbulb mr-2 text-yellow-500"></i><strong>Conseil:</strong> Ces données vous aident à négocier votre salaire et à évaluer la compétitivité des offres.</p>
                        </div>
                    </div>`;
                    
                    const modal = document.createElement('div');
                    modal.id = 'salary-insights-modal';
                    modal.className = 'modal-backdrop fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-70 z-[1050] flex items-center justify-center';
                    modal.innerHTML = `<div class="modal-panel bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl m-4 transform max-h-[90vh] flex flex-col">
                        <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10"><i class="fas fa-times fa-2x"></i></button>
                        <div class="overflow-y-auto p-8">
                            <h2 class="text-2xl font-bold text-center mb-6 dark:text-white"><i class="fas fa-chart-bar mr-2"></i>Baromètre des Salaires</h2>
                            ${content}
                        </div>
                    </div>`;
                    ui.modalContainer.appendChild(modal);
                    setTimeout(() => modal.querySelector('.modal-panel').classList.remove('hidden'), 10);
                }
                
                
                document.getElementById('login-form').addEventListener('submit', e => { e.preventDefault(); state.currentUser = {id: 99, name: "Recruteur Test", email: e.target.email.value, type: 'recruiter'}; closeAllModals(); updateAuthUI(); showToast('Connexion réussie !', 'success'); });
                document.getElementById('signup-candidate-form').addEventListener('submit', e => { e.preventDefault(); const name = e.target.name.value; state.currentUser = {id: data.length + 1, name, email: e.target.email.value, type: 'candidate'}; data.push({id: state.currentUser.id, type:'candidate', name, title: e.target.title.value, tags: e.target.tags.value.split(','), softSkills: [], location: {lat: 48.85, lon: 2.35}, city: 'Paris', experience: 'Junior', availability: 'Immédiate', description: 'Nouveau candidat'}); closeAllModals(); updateAuthUI(); showToast(`Bienvenue, ${name} !`, 'success'); performSearch(); });
                document.getElementById('signup-recruiter-form').addEventListener('submit', e => { e.preventDefault(); const name = e.target.name.value; state.currentUser = {id: data.length + 1, name, email: e.target.email.value, type: 'recruiter', company: e.target.company.value}; closeAllModals(); updateAuthUI(); showToast(`Bienvenue, ${name} !`, 'success'); });
                document.getElementById('signup-employer-form').addEventListener('submit', e => { e.preventDefault(); const name = e.target.name.value; state.currentUser = {id: data.length + 1, name, email: e.target.email.value, type: 'employer', company: e.target.companyName.value, siret: e.target.siret.value}; closeAllModals(); updateAuthUI(); showToast(`Bienvenue, ${name} !`, 'success'); });
                document.getElementById('post-job-form').addEventListener('submit', e => { e.preventDefault(); const newJob = {id: data.length + 1, type: 'job', title: e.target.title.value, company: e.target.company.value, city: e.target.city.value, description: e.target.description.value, tags: e.target.tags.value.split(','), softSkills: e.target.softSkills.value.split(','), experience: e.target.experience.value, salary: parseInt(e.target.salary.value), location: { lat: 48.85, lon: 2.35 }, contract: 'CDI', workArrangement: 'Hybride', companyDescription: '' }; data.push(newJob); closeAllModals(); showToast('Offre publiée !', 'success'); performSearch(); });
                document.getElementById('spontaneous-application-form').addEventListener('submit', e => { e.preventDefault(); const company = e.target.company.value; const message = e.target.message.value; if (!state.spontaneousApplications) state.spontaneousApplications = []; state.spontaneousApplications.push({ id: state.spontaneousApplications.length + 1, candidateId: state.currentUser.id, company, message, date: new Date().toISOString(), status: 'sent' }); closeAllModals(); showToast(`Candidature spontanée envoyée à ${company} !`, 'success'); });
                
                ui.favoritesBtn.addEventListener('click', showFavoritesModal);
                ui.locateMeBtn.addEventListener('click', getUserLocation);
                ui.saveSearchBtn.addEventListener('click', saveCurrentSearch);
                ui.helpBtn.addEventListener('click', showHelp);
                
                ui.darkModeToggle.addEventListener('click', () => { document.documentElement.classList.toggle('dark'); const icon = ui.darkModeToggle.querySelector('i'); if (document.documentElement.classList.contains('dark')) { icon.classList.replace('fa-moon', 'fa-sun'); localStorage.setItem('theme', 'dark'); } else { icon.classList.replace('fa-sun', 'fa-moon'); localStorage.setItem('theme', 'light'); } });
                if (localStorage.getItem('theme') === 'dark') { document.documentElement.classList.add('dark'); ui.darkModeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun'); }
                
                ui.userMenuButton.addEventListener('click', e => { e.stopPropagation(); ui.userMenu.classList.toggle('hidden'); ui.userMenu.classList.toggle('opacity-0'); ui.userMenu.classList.toggle('scale-95');});
                document.addEventListener('click', e => { if (!e.target.closest('#user-menu-button') && !e.target.closest('#user-menu')) { ui.userMenu.classList.add('hidden', 'opacity-0', 'scale-95'); }});
                ui.togglePanelBtn.addEventListener('click', () => ui.searchPanel.classList.toggle('collapsed'));
                ui.matchModeBtn.addEventListener('click', toggleMatchMode);
                ui.searchInput.addEventListener('keyup', performSearch);
                ui.filterContainer.addEventListener('click', e => { const target = e.target.closest('button'); if(target) { ui.filterContainer.querySelector('.active').classList.remove('active'); target.classList.add('active'); state.filters.type = target.dataset.filter; performSearch(); } });
                
                [ui.expFilterContainer, ui.contractFilterContainer, ui.workArrangementFilterContainer].forEach(container => {
                    container.addEventListener('click', e => {
                        const target = e.target.closest('.sub-filter-btn');
                        if (target) {
                            container.querySelector('.active').classList.remove('active'); target.classList.add('active');
                            if (target.dataset.exp) state.filters.experience = target.dataset.exp;
                            if (target.dataset.contract) state.filters.contract = target.dataset.contract;
                            if (target.dataset.work) state.filters.workArrangement = target.dataset.work;
                            performSearch();
                        }
                    });
                });
                
                ui.industryFilter.addEventListener('change', e => { state.filters.industry = e.target.value; performSearch(); });
                
                ui.salarySlider.addEventListener('input', e => { state.filters.salary = parseInt(e.target.value); ui.salaryValue.textContent = `${state.filters.salary.toLocaleString('fr-FR')} €`; });
                ui.salarySlider.addEventListener('change', performSearch);
                ui.distanceSlider.addEventListener('input', e => { state.filters.distance = parseInt(e.target.value); ui.distanceValue.textContent = `${state.filters.distance} km`; });
                ui.distanceSlider.addEventListener('change', performSearch);
                ui.exportDataBtn.addEventListener('click', exportData);
                ui.resultsList.addEventListener('click', e => { const card = e.target.closest('[data-id][data-lat]'); if (card) showDetailsModal(parseInt(card.dataset.id)); });
                map.on('popupopen', e => e.popup.getElement().querySelector('.view-details-btn')?.addEventListener('click', ev => showDetailsModal(ev.currentTarget.dataset.id)));
                
                ui.toggleResultsBtn.addEventListener('click', () => { ui.resultsList.classList.toggle('expanded'); const icon = ui.toggleResultsBtn.querySelector('i'); icon.classList.toggle('fa-chevron-up'); icon.classList.toggle('fa-chevron-down'); });
                ui.toggleFiltersBtn.addEventListener('click', () => { ui.advancedFilters.classList.toggle('collapsed'); const icon = ui.toggleFiltersBtn.querySelector('i'); icon.classList.toggle('fa-chevron-up'); icon.classList.toggle('fa-chevron-down'); });
                
                updateAuthUI(); performSearch();
            }
        });
    </script>
</body>
</html>


